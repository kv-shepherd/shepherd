# è§„èŒƒäº¤äº’æµç¨‹ (Master Flow)

> **Status**: Stable (ADR-0017, ADR-0018 Accepted)  
> **ç‰ˆæœ¬**: 1.0  
> **æ—¥æœŸ**: 2026-01-28  
> **è¯­è¨€**: ä¸­æ–‡ (ç¿»è¯‘ç‰ˆæœ¬)  
> **è§„èŒƒç‰ˆæœ¬**: [English Canonical Version](../../../../design/interaction-flows/master-flow.md)
>
> ğŸŒ **Other Languages**: [English (Canonical)](../../../../design/interaction-flows/master-flow.md)

---

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯ Shepherd å¹³å°æ‰€æœ‰äº¤äº’æµç¨‹çš„**ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬**ï¼Œæ˜¯å‰åç«¯å’Œæ•°æ®åº“å¼€å‘çš„**å‚è€ƒæ–‡æ¡£**ã€‚

> **æ³¨æ„**: è‹±æ–‡ç‰ˆæœ¬ (`docs/design/interaction-flows/master-flow.md`) æ˜¯è§„èŒƒç‰ˆæœ¬ (Canonical Version)ã€‚
> å¦‚æœ‰ä¸ä¸€è‡´ï¼Œä»¥è‹±æ–‡ç‰ˆæœ¬ä¸ºå‡†ã€‚

## æ–‡æ¡£èŒƒå›´

| åŒ…å«å†…å®¹ | ä¸åŒ…å«å†…å®¹ |
|----------|------------|
| ç”¨æˆ·äº¤äº’æµç¨‹ | æ•°æ®åº“ DDL/Schema å®šä¹‰ |
| æ•°æ®æµå‘ä¸æ¥æº | è¯¦ç»† API è§„èŒƒ |
| æ¦‚å¿µçŠ¶æ€å›¾ | å®ç°ä»£ç ç¤ºä¾‹ |
| ä¸šåŠ¡è§„åˆ™æ¦‚è¿° | åº•å±‚æŠ€æœ¯çº¦æŸ |

> **äº¤å‰å¼•ç”¨æ¨¡å¼**: æ¶‰åŠæ•°æ®æŒä¹…åŒ–çš„æ“ä½œåœ¨æœ¬æ–‡æ¡£æä¾›æ¦‚å¿µæ¦‚è¿°ï¼Œå®ç°ç»†èŠ‚è¯¦è§ Phase è®¾è®¡æ–‡æ¡£ã€‚
>
> ç¤ºä¾‹: "æ‰€æœ‰æ“ä½œéƒ½ä¼šåˆ›å»ºå®¡è®¡æ—¥å¿—ã€‚è¯¦è§ [04-governance.md Â§7](../phases/04-governance.md#7-audit-logging) äº†è§£ Schema è¯¦æƒ…ã€‚"

**ç›¸å…³æ–‡æ¡£**:
- [ADR-0018: Instance Size Abstraction](../../../../adr/ADR-0018-instance-size-abstraction.md)
- [ADR-0015: Governance Model V2](../../../../adr/ADR-0015-governance-model-v2.md)
- [ADR-0017: VM Request Flow](../../../../adr/ADR-0017-vm-request-flow-clarification.md)
- [Phase 01: å¥‘çº¦](../phases/01-contracts.md) â€” æ•°æ®å¥‘çº¦å’Œå‘½åçº¦æŸ
- [Phase 04: æ²»ç†](../phases/04-governance.md) â€” RBACã€å®¡è®¡æ—¥å¿—ã€å®¡æ‰¹æµç¨‹

---

## é™„å½•ï¼šè§„èŒƒäº¤äº’æµç¨‹ï¼ˆä¸­æ–‡ç‰ˆï¼‰

> **é‡è¦**: æœ¬èŠ‚ä¸º `docs/design/interaction-flows/master-flow.md` çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬ã€‚
> å¦‚æœ‰ä¸ä¸€è‡´ï¼Œä»¥è‹±æ–‡è§„èŒƒç‰ˆæœ¬ä¸ºå‡†ã€‚
### æ–‡æ¡£ç»“æ„

| Part | å†…å®¹ | æ¶‰åŠè§’è‰² |
|------|------|----------|
| **Part 1** | å¹³å°åˆå§‹åŒ–ï¼ˆSchema/Maskã€**é¦–æ¬¡éƒ¨ç½²å¼•å¯¼**ã€RBAC/æƒé™ã€OIDC/LDAP è®¤è¯ã€IdP ç»„æ˜ å°„ã€**å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ**ã€é›†ç¾¤/InstanceSize/Template é…ç½®ï¼‰ | å¼€å‘è€…ã€å¹³å°ç®¡ç†å‘˜ |
| **Part 2** | èµ„æºç®¡ç†ï¼ˆSystem/Service åˆ›å»ºåˆ é™¤åŠæ•°æ®åº“æ“ä½œã€**å«å®¡è®¡æ—¥å¿—**ï¼‰ | æ™®é€šç”¨æˆ· |
| **Part 3** | VM ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºè¯·æ±‚ â†’ å®¡æ‰¹ â†’ æ‰§è¡Œ â†’ åˆ é™¤åŠæ•°æ®åº“æ“ä½œã€**å«å®¡è®¡æ—¥å¿—**ï¼‰ | æ™®é€šç”¨æˆ·ã€å¹³å°ç®¡ç†å‘˜ |
| **Part 4** | çŠ¶æ€æœºä¸æ•°æ®æ¨¡å‹ï¼ˆçŠ¶æ€æµè½¬å›¾ã€è¡¨å…³ç³»å›¾ã€**å®¡è®¡æ—¥å¿—è®¾è®¡ä¸ä¾‹å¤–**ï¼‰ | æ‰€æœ‰å¼€å‘äººå‘˜ |

---

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **Schema ä¸ºå”¯ä¸€æ•°æ®æº** | KubeVirt å®˜æ–¹ JSON Schema å®šä¹‰å­—æ®µç±»å‹ã€çº¦æŸã€enum é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸åœ¨ä»£ç ä¸­é‡å¤å®šä¹‰ |
| **Mask åªé€‰æ‹©è·¯å¾„** | Mask åªæŒ‡å®šæš´éœ²å“ªäº› Schema è·¯å¾„ï¼Œä¸å®šä¹‰å­—æ®µé€‰é¡¹ |
| **æ··åˆæ¨¡å‹ (Hybrid Model)** | æ ¸å¿ƒè°ƒåº¦å­—æ®µï¼ˆCPUã€å†…å­˜ã€GPUï¼‰å­˜å‚¨åœ¨ç´¢å¼•åˆ—ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼›`spec_overrides` JSONB å­˜å‚¨å‰©ä½™å­—æ®µï¼Œä¸è¿›è¡Œè¯­ä¹‰è§£é‡Šã€‚å‚è§ ADR-0018 Â§4ã€‚ |
| **Schema é©±åŠ¨å‰ç«¯** | å‰ç«¯æ ¹æ® Schema ç±»å‹è‡ªåŠ¨æ¸²æŸ“å¯¹åº” UI ç»„ä»¶ã€‚æŠ€æœ¯æ ˆè¯¦è§ ADR-0020ï¼ˆReact 19, Next.js 15, Ant Design 5ï¼‰ã€‚ |

### è§’è‰²å®šä¹‰

| è§’è‰² | èŒè´£ | æ¥è§¦å±‚çº§ |
|------|------|---------|
| **å¼€å‘è€…** | è·å– KubeVirt Schemaï¼Œå®šä¹‰ Maskï¼ˆé€‰æ‹©æš´éœ²å“ªäº›è·¯å¾„ï¼‰ | ä»£ç /é…ç½®å±‚ |
| **å¹³å°ç®¡ç†å‘˜** | åˆ›å»º InstanceSizeï¼ˆé€šè¿‡ Schema é©±åŠ¨çš„è¡¨å•å¡«å†™å€¼ï¼‰ | åå°ç®¡ç†å±‚ |
| **æ™®é€šç”¨æˆ·** | é€‰æ‹© InstanceSizeï¼Œæäº¤ VM åˆ›å»ºè¯·æ±‚ | ä¸šåŠ¡ä½¿ç”¨å±‚ |

### å‘½åè§„èŒƒ (ADR-0019 å®‰å…¨åŸºçº¿)

> **å®‰å…¨åŸºçº¿**: æ‰€æœ‰å¹³å°ç®¡ç†çš„é€»è¾‘åç§°å¿…é¡»éµå¾ª RFC 1035 è§„åˆ™ã€‚

| è§„åˆ™ | çº¦æŸ |
|------|------|
| **å­—ç¬¦é›†** | ä»…å°å†™å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ (`a-z`, `0-9`, `-`) |
| **èµ·å§‹å­—ç¬¦** | å¿…é¡»ä»¥å­—æ¯å¼€å¤´ (`a-z`) |
| **ç»“æŸå­—ç¬¦** | å¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—ç»“å°¾ |
| **è¿ç»­è¿å­—ç¬¦** | ç¦æ­¢ `--` (ä¸º Punycode ä¿ç•™) |
| **é•¿åº¦é™åˆ¶** | System/Service/Namespace: æ¯ä¸ªæœ€å¤š 15 å­—ç¬¦ (ADR-0015 Â§16) |

**é€‚ç”¨èŒƒå›´**: System åç§°ã€Service åç§°ã€Namespace åç§°ã€VM åç§°ç»„ä»¶ã€‚

### API è®¾è®¡åŸåˆ™ (ADR-0021, ADR-0023)

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å¥‘çº¦ä¼˜å…ˆ** | OpenAPI 3.1 è§„èŒƒä¸ºå”¯ä¸€çœŸç†æ¥æºã€‚å‚è§ ADR-0021ã€‚ |
| **ä»£ç ç”Ÿæˆ** | Go æœåŠ¡ç«¯ç±»å‹é€šè¿‡ `oapi-codegen` ç”Ÿæˆï¼›TypeScript ç±»å‹é€šè¿‡ `openapi-typescript` ç”Ÿæˆã€‚ |
| **åˆ†é¡µæ ‡å‡†** | åˆ—è¡¨ API ä½¿ç”¨æ ‡å‡†åˆ†é¡µå‚æ•° (`page`, `per_page`, `sort_by`, `sort_order`)ã€‚å‚è§ ADR-0023ã€‚ |
| **é”™è¯¯ç ** | ç²’åº¦åŒ–é”™è¯¯ç ï¼ˆå¦‚ `NAMESPACE_PERMISSION_DENIED`ï¼‰ã€‚å‚è§ ADR-0023 Â§3ã€‚ |

### Schema ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ (ADR-0023)

> **ç›®çš„**: KubeVirt Schema ç¼“å­˜æ”¯æŒç¦»çº¿éªŒè¯ã€å¤šç‰ˆæœ¬å…¼å®¹å’Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–ã€‚

| é˜¶æ®µ | è§¦å‘æ—¶æœº | æ“ä½œ |
|------|----------|------|
| **1. å¯åŠ¨** | åº”ç”¨å¯åŠ¨ | åŠ è½½ç¼–è¯‘æ—¶åµŒå…¥çš„ Schema |
| **2. é›†ç¾¤æ³¨å†Œ** | æ–°å¢é›†ç¾¤ | æ£€æµ‹ KubeVirt ç‰ˆæœ¬ â†’ æ£€æŸ¥ç¼“å­˜ â†’ ç¼ºå¤±æ—¶æ’é˜Ÿè·å– |
| **3. ç‰ˆæœ¬æ£€æµ‹** | å¥åº·æ£€æŸ¥å¾ªç¯ (60s) | æ­è½½æ¨¡å¼: æ¯”è¾ƒ `clusters.kubevirt_version` ä¸æ£€æµ‹åˆ°çš„ç‰ˆæœ¬ |
| **4. Schema æ›´æ–°** | æ£€æµ‹åˆ°ç‰ˆæœ¬å˜æ›´ | æ’é˜Ÿ `SchemaUpdateJob` (River) â†’ å¼‚æ­¥è·å– â†’ æ›´æ–°ç¼“å­˜ |

**è¿‡æœŸç­–ç•¥**: Schema **æŒ‰ç‰ˆæœ¬ä¸å¯å˜**ï¼ˆv1.5.0 æ°¸ä¸æ”¹å˜ï¼‰ã€‚æ— é™æœŸç¼“å­˜ï¼Œä»…åœ¨ç‰ˆæœ¬å˜æ›´æ—¶æ›´æ–°ã€‚

**ä¼˜é›…é™çº§**: Schema è·å–å¤±è´¥ â†’ ä½¿ç”¨åµŒå…¥çš„å›é€€ç‰ˆæœ¬ â†’ ä¸‹æ¬¡å¥åº·æ£€æŸ¥æ—¶é‡è¯•ã€‚

è¯¦è§ ADR-0023 Â§1 å®Œæ•´ç¼“å­˜ç”Ÿå‘½å‘¨æœŸå›¾ã€‚

---

## Part 1: å¹³å°åˆå§‹åŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 1: å¹³å°åˆå§‹åŒ– (å¼€å‘è€…æ“ä½œ)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¼€å‘è€…:                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. è·å– KubeVirt å®˜æ–¹ JSON Schema                                                       â”‚ â”‚
â”‚  â”‚    - æ¥æº: KubeVirt CRD OpenAPI Schema æˆ–å®˜æ–¹æ–‡æ¡£                                        â”‚ â”‚
â”‚  â”‚    - åŒ…å«: æ‰€æœ‰å­—æ®µç±»å‹ã€çº¦æŸã€enum é€‰é¡¹                                                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚ 2. å®šä¹‰ Mask é…ç½® (åªé€‰æ‹©è·¯å¾„ï¼Œä¸å®šä¹‰é€‰é¡¹)                                                â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚    mask:                                                                                 â”‚ â”‚
â”‚  â”‚      quick_fields:                                                                       â”‚ â”‚
â”‚  â”‚        - path: "spec.template.spec.domain.cpu.cores"                                     â”‚ â”‚
â”‚  â”‚          display_name: "CPU æ ¸æ•°"                                                        â”‚ â”‚
â”‚  â”‚      advanced_fields:                                                                    â”‚ â”‚
â”‚  â”‚        - path: "spec.template.spec.domain.devices.gpus"                                  â”‚ â”‚
â”‚  â”‚          display_name: "GPU è®¾å¤‡"                                                        â”‚ â”‚
â”‚  â”‚        - path: "spec.template.spec.domain.memory.hugepages.pageSize"                     â”‚ â”‚
â”‚  â”‚          display_name: "Hugepages å¤§å°"                                                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚    ğŸ‘‰ Mask åªå¼•ç”¨ Schema è·¯å¾„ï¼Œå­—æ®µç±»å‹å’Œé€‰é¡¹ç”± Schema å®šä¹‰                               â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚ 3. å‰ç«¯æ ¹æ® Schema + Mask è‡ªåŠ¨æ¸²æŸ“ UI                                                    â”‚ â”‚
â”‚  â”‚    - integer â†’ æ•°å­—è¾“å…¥æ¡†                                                                â”‚ â”‚
â”‚  â”‚    - string â†’ æ–‡æœ¬è¾“å…¥æ¡†                                                                 â”‚ â”‚
â”‚  â”‚    - boolean â†’ å¤é€‰æ¡†                                                                    â”‚ â”‚
â”‚  â”‚    - enum â†’ ä¸‹æ‹‰æ¡† (é€‰é¡¹æ¥è‡ª Schemaï¼Œä¸æ˜¯å¼€å‘è€…å®šä¹‰)                                       â”‚ â”‚
â”‚  â”‚    - array â†’ åŠ¨æ€æ·»åŠ /åˆ é™¤è¡¨æ ¼                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜¶æ®µ 1.5: é¦–æ¬¡éƒ¨ç½²å¼•å¯¼ (Bootstrap) {#stage-1-5}

> **Added 2026-01-26**: é…ç½®å­˜å‚¨ç­–ç•¥çš„é¦–æ¬¡éƒ¨ç½²æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 1.5: é¦–æ¬¡éƒ¨ç½²å¼•å¯¼                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ğŸ”§ éƒ¨ç½²é…ç½® (äºŒé€‰ä¸€):                                                                         â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“ æ–¹å¼ A: config.yaml (æœ¬åœ°å¼€å‘ / ä¼ ç»Ÿéƒ¨ç½²)                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  # config.yaml                                                                          â”‚ â”‚
â”‚  â”‚  database:                                                                              â”‚ â”‚
â”‚  â”‚    url: "postgresql://user:pass@localhost:5432/shepherd"                                â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  server:                                                                                 â”‚ â”‚
â”‚  â”‚    port: 8080                                                                            â”‚ â”‚
â”‚  â”‚    log_level: "info"                     # å¯é€‰ï¼Œé»˜è®¤ info                                â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  worker:                                                                                 â”‚ â”‚
â”‚  â”‚    max_workers: 10                       # å¯é€‰ï¼Œé»˜è®¤ 10                                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  security:                                                                               â”‚ â”‚
â”‚  â”‚    encryption_key: "32-byte-hex"         # å¯é€‰ï¼Œç”¨äºåŠ å¯†æ•æ„Ÿæ•°æ®                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ³ æ–¹å¼ B: ç¯å¢ƒå˜é‡ (å®¹å™¨åŒ–éƒ¨ç½²)                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DATABASE_URL=postgresql://user:pass@host:5432/shepherd    # å¿…éœ€                       â”‚ â”‚
â”‚  â”‚  SERVER_PORT=8080                        # å¯é€‰ï¼Œé»˜è®¤ 8080                               â”‚ â”‚
â”‚  â”‚  LOG_LEVEL=info                          # å¯é€‰ï¼Œé»˜è®¤ info                                â”‚ â”‚
â”‚  â”‚  RIVER_MAX_WORKERS=10                    # å¯é€‰ï¼Œé»˜è®¤ 10                                  â”‚ â”‚
â”‚  â”‚  ENCRYPTION_KEY=<32-byte-hex-string>     # å¯é€‰ï¼Œç”¨äºåŠ å¯†æ•æ„Ÿæ•°æ®                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  âš¡ ä¼˜å…ˆçº§: ç¯å¢ƒå˜é‡ > config.yaml > é»˜è®¤å€¼                                                    â”‚
â”‚  ğŸ’¡ ç¯å¢ƒå˜é‡å§‹ç»ˆè¦†ç›– config.yaml (12-factor app åŸåˆ™)                                          â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ åº”ç”¨è‡ªåŠ¨åˆå§‹åŒ–:                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è¿è¡Œ migrations                                                                    â”‚ â”‚
â”‚  â”‚  2. Seed å†…ç½®è§’è‰² (ON CONFLICT DO NOTHING - ä¸è¦†ç›–å·²æœ‰)                                 â”‚ â”‚
â”‚  â”‚  3. Seed é»˜è®¤ç®¡ç†å‘˜ admin/admin (force_password_change=true)                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ–¥ï¸ é¦–æ¬¡ç™»å½•æç¤º:                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚                    âš ï¸ é¦–æ¬¡ç™»å½•                                                       â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    è¯·ä½¿ç”¨é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ç™»å½•:                                                          â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    ç”¨æˆ·å: admin                                                                     â”‚   â”‚
â”‚  â”‚    å¯†ç :   admin                                                                     â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    âš ï¸ ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç !                                                          â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    [ç™»å½•]                                                                            â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” å¼ºåˆ¶ä¿®æ”¹å¯†ç :                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚                    ğŸ” è¯·è®¾ç½®æ–°å¯†ç                                                    â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    æ‚¨æ­£åœ¨ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œè¯·ç«‹å³ä¿®æ”¹ä»¥ä¿è¯è´¦æˆ·å®‰å…¨ã€‚                                      â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    æ–°å¯†ç :     [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                ]                                        â”‚   â”‚
â”‚  â”‚    ç¡®è®¤å¯†ç :   [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                ]                                        â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    å¯†ç è¦æ±‚ (NIST 800-63B):                                                          â”‚   â”‚
â”‚  â”‚    âœ“ æœ€å°‘ 8 ä¸ªå­—ç¬¦ï¼ˆå»ºè®® 15+ å­—ç¬¦ï¼‰                                                   â”‚   â”‚
â”‚  â”‚    âœ“ ä¸åœ¨å¸¸è§å¯†ç é»‘åå•ä¸­                                                             â”‚   â”‚
â”‚  â”‚    â—‹ å¤æ‚åº¦è§„åˆ™é»˜è®¤ä¸å¼ºåˆ¶ï¼ˆå¯é…ç½®ä»¥æ»¡è¶³åˆè§„è¦æ±‚ï¼‰                                       â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    [ç¡®è®¤ä¿®æ”¹]                                                                        â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- Seed é»˜è®¤ç®¡ç†å‘˜ (é¦–æ¬¡å¯åŠ¨)                                                      â”‚       â”‚
â”‚  â”‚  INSERT INTO users (id, username, password_hash, auth_type, force_password_change) â”‚       â”‚
â”‚  â”‚  VALUES ('admin', 'admin', bcrypt('admin'), 'local', true)                         â”‚       â”‚
â”‚  â”‚  ON CONFLICT (username) DO NOTHING;                                                 â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å…³è” PlatformAdmin è§’è‰²                                                         â”‚       â”‚
â”‚  â”‚  INSERT INTO role_bindings (id, user_id, role_id, scope_type, source)              â”‚       â”‚
â”‚  â”‚  VALUES ('rb-admin', 'admin', 'role-platform-admin', 'global', 'seed')             â”‚       â”‚
â”‚  â”‚  ON CONFLICT DO NOTHING;                                                            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- ä¿®æ”¹å¯†ç å                                                                       â”‚       â”‚
â”‚  â”‚  UPDATE users SET                                                                   â”‚       â”‚
â”‚  â”‚    password_hash = bcrypt('new_password'),                                          â”‚       â”‚
â”‚  â”‚    force_password_change = false,                                                   â”‚       â”‚
â”‚  â”‚    updated_at = NOW()                                                               â”‚       â”‚
â”‚  â”‚  WHERE id = 'admin';                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å®¡è®¡æ—¥å¿—                                                                         â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id, details)    â”‚       â”‚
â”‚  â”‚  VALUES ('user.password_change', 'admin', 'user', 'admin',                         â”‚       â”‚
â”‚  â”‚          '{"reason": "first_login_forced"}');                                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âœ… å®Œæˆåè¿›å…¥ç®¡ç†åå°ï¼Œç»§ç»­é˜¶æ®µ 2                                                            â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜¶æ®µ 2: å¹³å°å®‰å…¨é…ç½® (é¦–æ¬¡éƒ¨ç½²) {#stage-2}

> **å‚è€ƒ**: ADR-0015 Â§22 (Authentication & RBAC Strategy)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.A: å†…ç½®è§’è‰²ä¸æƒé™åˆå§‹åŒ–                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ğŸ”§ ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ (Seed Data):                                                                 â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- 1. å†…ç½®æƒé™ (Permissions)                                                      â”‚       â”‚
â”‚  â”‚  INSERT INTO permissions (id, resource, action, name) VALUES                      â”‚       â”‚
â”‚  â”‚    ('system:read', 'system', 'read', 'æŸ¥çœ‹ç³»ç»Ÿ'),                                  â”‚       â”‚
â”‚  â”‚    ('system:write', 'system', 'write', 'ä¿®æ”¹ç³»ç»Ÿ'),                                â”‚       â”‚
â”‚  â”‚    ('system:delete', 'system', 'delete', 'åˆ é™¤ç³»ç»Ÿ'),                              â”‚       â”‚
â”‚  â”‚    ('service:read', 'service', 'read', 'æŸ¥çœ‹æœåŠ¡'),                                â”‚       â”‚
â”‚  â”‚    ('service:create', 'service', 'create', 'åˆ›å»ºæœåŠ¡'),                            â”‚       â”‚
â”‚  â”‚    ('service:delete', 'service', 'delete', 'åˆ é™¤æœåŠ¡'),                            â”‚       â”‚
â”‚  â”‚    ('vm:read', 'vm', 'read', 'æŸ¥çœ‹VM'),                                           â”‚       â”‚
â”‚  â”‚    ('vm:create', 'vm', 'create', 'åˆ›å»ºVMè¯·æ±‚'),                                   â”‚       â”‚
â”‚  â”‚    ('vm:operate', 'vm', 'operate', 'VMæ“ä½œ(å¯åœ)'),                                â”‚       â”‚
â”‚  â”‚    ('vm:delete', 'vm', 'delete', 'åˆ é™¤VM'),                                       â”‚       â”‚
â”‚  â”‚    ('vnc:access', 'vnc', 'access', 'VNCæ§åˆ¶å°'),                                   â”‚       â”‚
â”‚  â”‚    ('approval:approve', 'approval', 'approve', 'å®¡æ‰¹è¯·æ±‚'),                        â”‚       â”‚
â”‚  â”‚    ('approval:view', 'approval', 'view', 'æŸ¥çœ‹å¾…å®¡æ‰¹'),                             â”‚       â”‚
â”‚  â”‚    ('cluster:manage', 'cluster', 'manage', 'ç®¡ç†é›†ç¾¤'),                            â”‚       â”‚
â”‚  â”‚    ('template:manage', 'template', 'manage', 'ç®¡ç†æ¨¡æ¿'),                          â”‚       â”‚
â”‚  â”‚    ('rbac:manage', 'rbac', 'manage', 'ç®¡ç†æƒé™'),                                  â”‚       â”‚
â”‚  â”‚    ('platform:admin', 'platform', 'admin', 'è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆæ˜¾å¼ï¼‰'),               â”‚       â”‚
â”‚  â”‚    -- âš ï¸ å·²åºŸå¼ƒ: *:* é€šé…ç¬¦ä»…é™ bootstrap è§’è‰²ä½¿ç”¨ (ADR-0019)                       â”‚       â”‚
â”‚  â”‚    ('*:*', '*', '*', 'Bootstrapä¸“ç”¨é€šé…ç¬¦ - åˆå§‹åŒ–åå¿…é¡»ç¦ç”¨');                      â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. å†…ç½®è§’è‰² (ADR-0019 åˆè§„)                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO roles (id, name, is_builtin, description) VALUES                     â”‚       â”‚
â”‚  â”‚    ('role-bootstrap', 'Bootstrap', true, 'åˆå§‹åŒ–ä¸“ç”¨ - éƒ¨ç½²åå¿…é¡»ç¦ç”¨'),            â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'PlatformAdmin', true, 'å¹³å°ç®¡ç†å‘˜'),                   â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'SystemAdmin', true, 'ç³»ç»Ÿç®¡ç†å‘˜'),                        â”‚       â”‚
â”‚  â”‚    ('role-approver', 'Approver', true, 'å®¡æ‰¹å‘˜'),                                  â”‚       â”‚
â”‚  â”‚    ('role-operator', 'Operator', true, 'è¿ç»´äººå‘˜'),                                 â”‚       â”‚
â”‚  â”‚    ('role-viewer', 'Viewer', true, 'åªè¯»ç”¨æˆ·');                                    â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. è§’è‰²-æƒé™å…³è” (ADR-0019: ä»… bootstrap å¯ä½¿ç”¨é€šé…ç¬¦)                           â”‚       â”‚
â”‚  â”‚  INSERT INTO role_permissions (role_id, permission_id) VALUES                     â”‚       â”‚
â”‚  â”‚    -- Bootstrap è§’è‰²: é€šé…ç¬¦ (å¹³å°åˆå§‹åŒ–åå¿…é¡»ç¦ç”¨)                                  â”‚       â”‚
â”‚  â”‚    ('role-bootstrap', '*:*'),                                                      â”‚       â”‚
â”‚  â”‚    -- PlatformAdmin: æ˜¾å¼æƒé™åˆ—è¡¨ (ADR-0019 ç¦æ­¢é€šé…ç¬¦)                             â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'system:read'), ('role-platform-admin', 'system:write'),â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'system:delete'), ('role-platform-admin', 'service:read'),â”‚     â”‚
â”‚  â”‚    ('role-platform-admin', 'service:create'), ('role-platform-admin', 'service:delete'),â”‚  â”‚
â”‚  â”‚    ('role-platform-admin', 'vm:read'), ('role-platform-admin', 'vm:create'),       â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'vm:operate'), ('role-platform-admin', 'vm:delete'),    â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'vnc:access'), ('role-platform-admin', 'approval:approve'),â”‚    â”‚
â”‚  â”‚    ('role-platform-admin', 'approval:view'), ('role-platform-admin', 'cluster:manage'),â”‚   â”‚
â”‚  â”‚    ('role-platform-admin', 'template:manage'), ('role-platform-admin', 'rbac:manage'),â”‚    â”‚
â”‚  â”‚    -- Approver: æ˜¾å¼æƒé™ (ADR-0019 ç¦æ­¢é€šé…ç¬¦)                                       â”‚       â”‚
â”‚  â”‚    ('role-approver', 'approval:approve'), ('role-approver', 'approval:view'),      â”‚       â”‚
â”‚  â”‚    ('role-approver', 'vm:read'), ('role-approver', 'system:read'),                 â”‚       â”‚
â”‚  â”‚    ('role-approver', 'service:read'),                                              â”‚       â”‚
â”‚  â”‚    -- SystemAdmin, Operator, Viewer: æ˜¾å¼æƒé™                                       â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'system:read'), ('role-system-admin', 'system:write'),    â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'system:delete'), ('role-system-admin', 'service:read'),  â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'service:create'), ('role-system-admin', 'service:delete'),â”‚      â”‚
â”‚  â”‚    ('role-system-admin', 'vm:read'), ('role-system-admin', 'vm:create'),           â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'vm:operate'), ('role-system-admin', 'vm:delete'),        â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'vnc:access'), ('role-system-admin', 'rbac:manage'),      â”‚       â”‚
â”‚  â”‚    ('role-operator', 'system:read'), ('role-operator', 'service:read'),            â”‚       â”‚
â”‚  â”‚    ('role-operator', 'vm:read'), ('role-operator', 'vm:create'),                   â”‚       â”‚
â”‚  â”‚    ('role-operator', 'vm:operate'), ('role-operator', 'vnc:access'),               â”‚       â”‚
â”‚  â”‚    ('role-viewer', 'system:read'), ('role-viewer', 'service:read'),                â”‚       â”‚
â”‚  â”‚    ('role-viewer', 'vm:read');                                                     â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- âš ï¸ ADR-0019 å®‰å…¨ SOP:                                                           â”‚       â”‚
â”‚  â”‚  -- å¹³å°åˆå§‹åŒ–å®Œæˆåï¼Œå¿…é¡»ç¦ç”¨ bootstrap è§’è‰²:                                        â”‚       â”‚
â”‚  â”‚  --   DELETE FROM role_bindings WHERE role_id = 'role-bootstrap';                  â”‚       â”‚
â”‚  â”‚  -- è¯¦è§ docs/operations/bootstrap-role-sop.md                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.A+: è‡ªå®šä¹‰è§’è‰²ç®¡ç† (å¯é€‰)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ (åœ¨ OIDC é…ç½®ä¹‹å‰æˆ–ä¹‹åå‡å¯):                                                    â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: åˆ›å»ºè‡ªå®šä¹‰è§’è‰² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  è§’è‰²ç®¡ç†                                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è§’è‰²åˆ—è¡¨:                                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] PlatformAdmin          å†…ç½®    å¹³å°ç®¡ç†å‘˜-å…¨éƒ¨æƒé™                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] SystemAdmin            å†…ç½®    ç³»ç»Ÿç®¡ç†å‘˜                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] Approver               å†…ç½®    å®¡æ‰¹å‘˜                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] Operator               å†…ç½®    è¿ç»´äººå‘˜                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] Viewer                 å†…ç½®    åªè¯»ç”¨æˆ·                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [  ] DevLead                è‡ªå®šä¹‰   å¼€å‘ä¸»ç®¡ (å¯ç¼–è¾‘/åˆ é™¤)                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [  ] QA-Manager             è‡ªå®šä¹‰   QA ç®¡ç†å‘˜ (å¯ç¼–è¾‘/åˆ é™¤)                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [+ åˆ›å»ºè‡ªå®šä¹‰è§’è‰²]                                                               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: é…ç½®è‡ªå®šä¹‰è§’è‰²æƒé™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  åˆ›å»ºè‡ªå®šä¹‰è§’è‰²                                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è§’è‰²åç§°:     [DevLead              ]                                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  è§’è‰²æè¿°:     [å¼€å‘ä¸»ç®¡-å¯ç®¡ç†ç³»ç»Ÿå’ŒæœåŠ¡]                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  é€‰æ‹©æƒé™ (å…¨å±€æƒé™):                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€ ç³»ç»Ÿç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ å®¡æ‰¹ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ system:read              â”‚  â”‚ â˜ approval:approve        â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ system:write             â”‚  â”‚ â˜ approval:view           â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜ system:delete            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€ æœåŠ¡ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ å¹³å°ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ service:read             â”‚  â”‚ â˜ cluster:manage          â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ service:create           â”‚  â”‚ â˜ template:manage         â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜ service:delete           â”‚  â”‚ â˜ rbac:manage             â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€ VM ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vm:read                  â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vm:create                â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vm:operate               â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜ vm:delete                â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vnc:access               â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä¿å­˜è§’è‰²]                                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- åˆ›å»ºè‡ªå®šä¹‰è§’è‰²                                                                  â”‚       â”‚
â”‚  â”‚  INSERT INTO roles (id, name, is_builtin, description) VALUES                     â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'DevLead', false, 'å¼€å‘ä¸»ç®¡-å¯ç®¡ç†ç³»ç»Ÿå’ŒæœåŠ¡');                 â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å…³è”æƒé™                                                                        â”‚       â”‚
â”‚  â”‚  INSERT INTO role_permissions (role_id, permission_id) VALUES                     â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'system:read'), ('role-dev-lead', 'system:write'),           â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'service:read'), ('role-dev-lead', 'service:create'),        â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'vm:read'), ('role-dev-lead', 'vm:create'),                  â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'vm:operate'), ('role-dev-lead', 'vnc:access');              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ è‡ªå®šä¹‰è§’è‰²åˆ›å»ºåï¼Œå¯åœ¨ OIDC ç»„æ˜ å°„ (é˜¶æ®µ 2.C) ä¸­é€‰æ‹©ä½¿ç”¨                                     â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.B: é…ç½®è®¤è¯æ–¹å¼ (OIDC/LDAP)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ:                                                                               â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: é€‰æ‹©è®¤è¯æ–¹å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  é…ç½®èº«ä»½è®¤è¯                                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è®¤è¯æ–¹å¼:                                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‰ OIDC (æ¨è)   - é€‚ç”¨äº: Azure AD, Okta, Keycloak, Google Workspace           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ LDAP          - é€‚ç”¨äº: Active Directory, OpenLDAP                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ å†…ç½®ç”¨æˆ·       - ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒ                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä¸‹ä¸€æ­¥ â†’]                                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: OIDC é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  OIDC Provider é…ç½®                                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Provider åç§°:  [Corp-SSO                    ]                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Issuer URL:     [https://sso.company.com/realms/main]                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Client ID:      [shepherd-platform           ]                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Client Secret:  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                ] ğŸ‘                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Callback URL (å¤åˆ¶åˆ° IdP):                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ“‹ https://shepherd.company.com/api/v1/auth/oidc/callback                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [æµ‹è¯•è¿æ¥]  [ä¿å­˜é…ç½®]                                                           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  INSERT INTO idp_configs (id, type, name, issuer_url, client_id, client_secret)   â”‚       â”‚
â”‚  â”‚  VALUES ('idp-001', 'oidc', 'Corp-SSO', 'https://sso.company.com/realms/main',    â”‚       â”‚
â”‚  â”‚          'shepherd-platform', 'encrypted:xxx');                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.C: IdP ç»„æ˜ å°„é…ç½®                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ:                                                                               â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: è·å–æ ·æœ¬ç”¨æˆ·æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  API: GET /api/v1/admin/idp/{id}/sample                                               â”‚   â”‚
â”‚  â”‚  ç³»ç»Ÿä» IdP æ‹‰å– 10 ä¸ªç”¨æˆ·çš„ Token æ•°æ®ï¼Œæå–å¯ç”¨å­—æ®µ:                                    â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  æ£€æµ‹åˆ°çš„å­—æ®µ:                                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‰ groups (array, 5 ä¸ªå”¯ä¸€å€¼)                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     æ ·æœ¬: ["DevOps-Team", "QA-Team", "Platform-Admin", ...]                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ department (string, 3 ä¸ªå”¯ä¸€å€¼)                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     æ ·æœ¬: ["Engineering", "IT", "QA"]                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ custom_roles (array, 2 ä¸ªå”¯ä¸€å€¼)                                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     æ ·æœ¬: ["admin", "developer"]                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [åŒæ­¥é€‰ä¸­å­—æ®µ â†’]                                                                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: é…ç½®ç»„-è§’è‰²æ˜ å°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  IdP Group â†’ Shepherd Role æ˜ å°„                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  IdP ç»„              Shepherd è§’è‰²      å¯è®¿é—®ç¯å¢ƒ                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Platform-Admin     [PlatformAdmin â–¼]   â˜‘ test  â˜‘ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  DevOps-Team        [SystemAdmin â–¼]     â˜‘ test  â˜‘ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  QA-Team            [Operator â–¼]        â˜‘ test  â˜ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  IT-Support         [Viewer â–¼]          â˜‘ test  â˜ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  HR-Department      [æ— æ˜ å°„ â–¼]          -                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’¡ æœªæ˜ å°„çš„ç»„é»˜è®¤è·å¾—: Viewer æƒé™ + ä»… test ç¯å¢ƒ                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä¿å­˜æ˜ å°„]                                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- åŒæ­¥ IdP ç»„                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO idp_synced_groups (id, idp_config_id, group_id, source_field)        â”‚       â”‚
â”‚  â”‚  VALUES ('sg-001', 'idp-001', 'Platform-Admin', 'groups'),                        â”‚       â”‚
â”‚  â”‚         ('sg-002', 'idp-001', 'DevOps-Team', 'groups'),                           â”‚       â”‚
â”‚  â”‚         ('sg-003', 'idp-001', 'QA-Team', 'groups');                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- ä¿å­˜æ˜ å°„å…³ç³»                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO idp_group_mappings (id, idp_config_id, idp_group_id, role_id,        â”‚       â”‚
â”‚  â”‚                                  scope_type, allowed_environments) VALUES         â”‚       â”‚
â”‚  â”‚    ('map-001', 'idp-001', 'Platform-Admin', 'role-platform-admin',                â”‚       â”‚
â”‚  â”‚     'global', ARRAY['test', 'prod']),                                             â”‚       â”‚
â”‚  â”‚    ('map-002', 'idp-001', 'DevOps-Team', 'role-system-admin',                     â”‚       â”‚
â”‚  â”‚     'global', ARRAY['test', 'prod']),                                             â”‚       â”‚
â”‚  â”‚    ('map-003', 'idp-001', 'QA-Team', 'role-operator',                             â”‚       â”‚
â”‚  â”‚     'global', ARRAY['test']);                                                     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.D: ç”¨æˆ·ç™»å½•æµç¨‹                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·é¦–æ¬¡ç™»å½•:                                                                                â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. ç”¨æˆ·è®¿é—® https://shepherd.company.com                                              â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  2. é‡å®šå‘åˆ° IdP ç™»å½•é¡µé¢                                                               â”‚ â”‚
â”‚  â”‚     â†’ https://sso.company.com/realms/main/protocol/openid-connect/auth?                â”‚ â”‚
â”‚  â”‚       client_id=shepherd-platform&redirect_uri=...                                     â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  3. ç”¨æˆ·åœ¨ IdP å®Œæˆè®¤è¯                                                                 â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  4. IdP å›è°ƒ Shepherd                                                                  â”‚ â”‚
â”‚  â”‚     â† https://shepherd.company.com/api/v1/auth/oidc/callback?code=xxx                  â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  5. Shepherd å¤„ç†:                                                                      â”‚ â”‚
â”‚  â”‚     a. éªŒè¯ Token (ç­¾åã€issuerã€audience)                                             â”‚ â”‚
â”‚  â”‚     b. æå–ç”¨æˆ·ä¿¡æ¯ (sub, email, name, groups)                                         â”‚ â”‚
â”‚  â”‚     c. æ ¹æ® groups æŸ¥æ‰¾ idp_group_mappings                                             â”‚ â”‚
â”‚  â”‚     d. åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•                                                                â”‚ â”‚
â”‚  â”‚     e. åˆ›å»º RoleBindings (åŸºäºæ˜ å°„)                                                     â”‚ â”‚
â”‚  â”‚     f. è¿”å› JWT Session Token                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (ç”¨æˆ·é¦–æ¬¡ç™»å½•):                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºç”¨æˆ·è®°å½• (å¦‚æœä¸å­˜åœ¨)                                                     â”‚       â”‚
â”‚  â”‚  INSERT INTO users (id, external_id, email, name, idp_config_id, created_at)      â”‚       â”‚
â”‚  â”‚  VALUES ('user-001', 'oidc|abc123', 'zhang.san@company.com', 'å¼ ä¸‰',               â”‚       â”‚
â”‚  â”‚          'idp-001', NOW())                                                         â”‚       â”‚
â”‚  â”‚  ON CONFLICT (external_id) DO UPDATE SET last_login_at = NOW();                   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. åˆ é™¤æ—§çš„ IdP è‡ªåŠ¨åˆ†é…çš„ RoleBindings (æ ‡è®°ä¸º auto_assigned)                   â”‚       â”‚
â”‚  â”‚  DELETE FROM role_bindings                                                         â”‚       â”‚
â”‚  â”‚  WHERE user_id = 'user-001' AND source = 'idp_mapping';                           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. æ ¹æ®ç”¨æˆ·çš„ groups é‡æ–°åˆ›å»º RoleBindings                                       â”‚       â”‚
â”‚  â”‚  -- (ç”¨æˆ· groups: ['DevOps-Team'] â†’ æ˜ å°„åˆ° role-system-admin)                       â”‚       â”‚
â”‚  â”‚  INSERT INTO role_bindings (id, user_id, role_id, scope_type,                     â”‚       â”‚
â”‚  â”‚                             allowed_environments, source) VALUES                  â”‚       â”‚
â”‚  â”‚    ('rb-auto-001', 'user-001', 'role-system-admin', 'global',                     â”‚       â”‚
â”‚  â”‚     ARRAY['test', 'prod'], 'idp_mapping');                                        â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç”¨æˆ·ç™»å½•æ–¹å¼æ€»ç»“

| ç™»å½•æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æƒé™æ¥æº |
|----------|----------|----------|
| **OIDC** | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ | IdP ç»„ â†’ æ˜ å°„è§„åˆ™ â†’ RoleBindings |
| **LDAP** | é—ç•™ AD ç¯å¢ƒ | LDAP ç»„ â†’ æ˜ å°„è§„åˆ™ â†’ RoleBindings |
| **å†…ç½®ç”¨æˆ·** | å¼€å‘/æµ‹è¯• | æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·å’Œ RoleBindings |

#### åŒå±‚æƒé™ä½“ç³»æ€»ç»“

| ç»´åº¦ | å…¨å±€ RBAC | èµ„æºçº§ RBAC |
|------|-----------|-------------|
| **å­˜å‚¨è¡¨** | `role_bindings` | `resource_role_bindings` |
| **æƒé™èŒƒå›´** | å¹³å°çº§æ“ä½œ | ç‰¹å®šèµ„æºè®¿é—® |
| **è§’è‰²ç±»å‹** | PlatformAdmin, SystemAdmin, Approver, Operator, Viewer, è‡ªå®šä¹‰è§’è‰² | Owner, Admin, Member, Viewer |
| **æˆæƒæ–¹å¼** | ç®¡ç†å‘˜é€šè¿‡ OIDC ç»„æ˜ å°„æˆ–æ‰‹åŠ¨åˆ†é… | èµ„æºåˆ›å»ºè€…è‡ªè¡Œæ·»åŠ æˆå‘˜ |
| **å…¸å‹åœºæ™¯** | "å¼ ä¸‰å¯ä»¥å®¡æ‰¹ VM è¯·æ±‚" | "æå››å¯ä»¥è®¿é—®å¼ ä¸‰çš„ shop ç³»ç»Ÿ" |
| **å¯è§æ€§æ§åˆ¶** | æ— ï¼ˆå…¨å±€æƒé™ï¼‰ | æœ‰ï¼ˆä»…æˆå‘˜å¯è§ï¼‰ |
| **ç»§æ‰¿æ¨¡å‹** | N/A | âœ… Service/VM å®Œå…¨ç»§æ‰¿ System æƒé™ |

#### æƒé™æ£€æŸ¥é€»è¾‘

> **ä¸¤å±‚æƒé™ä½“ç³»**: Shepherd é‡‡ç”¨åŒå±‚æƒé™è®¾è®¡ï¼š
> - **å…¨å±€ RBAC (role_bindings)**: æ§åˆ¶å¹³å°çº§æ“ä½œæƒé™ï¼ˆç®¡ç†é›†ç¾¤ã€æ¨¡æ¿ã€å®¡æ‰¹ç­‰ï¼‰
> - **èµ„æºçº§ RBAC (resource_role_bindings)**: æ§åˆ¶å…·ä½“èµ„æºçš„è®¿é—®æƒé™ï¼ˆæˆ‘çš„ System å¯¹ä½ ä¸å¯è§ï¼‰

```
å®Œæ•´æƒé™æ£€æŸ¥æµç¨‹:

ç”¨æˆ·è¯·æ±‚è®¿é—®èµ„æº R (ä¾‹å¦‚: GET /api/v1/systems/sys-001)

â”Œâ”€ Step 1: å…¨å±€æƒé™æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢ role_bindings â†’ èšåˆ Permissions                                            â”‚
â”‚  - å¦‚æœç”¨æˆ·æœ‰ platform:admin æƒé™ â†’ å…è®¸è®¿é—®æ‰€æœ‰èµ„æºï¼ˆæ˜¾å¼è¶…çº§ç®¡ç†å‘˜ï¼‰               â”‚
â”‚  - å¦‚æœç”¨æˆ·æœ‰å¯¹åº”å…¨å±€æƒé™ (system:read) â†’ è¿›å…¥ Step 2                               â”‚
â”‚  - å¦åˆ™ â†’ æ‹’ç»è®¿é—®                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€ Step 2: èµ„æºçº§æƒé™æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢ resource_role_bindings WHERE resource_id = 'sys-001' AND user_id = ?        â”‚
â”‚  - å¦‚æœæ‰¾åˆ°è®°å½• (owner/admin/member/viewer) â†’ æ ¹æ®è§’è‰²å†³å®šæ“ä½œæƒé™                  â”‚
â”‚  - å¦‚æœæœªæ‰¾åˆ° â†’ æ£€æŸ¥èµ„æºç»§æ‰¿é“¾ (VM â†’ Service â†’ System)                              â”‚
â”‚  - æœ€ç»ˆæœªæ‰¾åˆ° â†’ æ‹’ç»è®¿é—® (èµ„æºå¯¹æ­¤ç”¨æˆ·ä¸å¯è§)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ 1: å¼ ä¸‰ (DevOps-Team) è®¿é—®è‡ªå·±åˆ›å»ºçš„ System
1. å…¨å±€æƒé™: system:read âˆˆ SystemAdmin æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™: resource_role_bindings ä¸­ role='owner' â†’ âœ… å…è®¸

ç¤ºä¾‹ 2: æå›› (IT-Support) è®¿é—®å¼ ä¸‰çš„ System
1. å…¨å±€æƒé™: system:read âˆˆ Viewer æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™: æœªæ‰¾åˆ° resource_role_binding è®°å½• â†’ âŒ èµ„æºä¸å¯è§

ç¤ºä¾‹ 3: æå››è¢«å¼ ä¸‰æ·»åŠ ä¸º System æˆå‘˜å
1. å…¨å±€æƒé™: system:read âˆˆ Viewer æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™: resource_role_bindings ä¸­ role='member' â†’ âœ… å…è®¸æŸ¥çœ‹

ç¤ºä¾‹ 4: æå››è®¿é—®å¼ ä¸‰ System ä¸‹çš„ VM (æƒé™ç»§æ‰¿)
è®¿é—®ç›®æ ‡: vm-001 (å±äº svc-redis â†’ å±äº sys-shop)
1. å…¨å±€æƒé™: vm:read âˆˆ Viewer æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™ (å‘ä¸Šéå†):
   a. æ£€æŸ¥ vm-001 çš„ binding â†’ æ—  (VM å±‚ä¸é…ç½®æˆå‘˜)
   b. æ£€æŸ¥ svc-redis çš„ binding â†’ æ—  (Service å±‚ä¸é…ç½®æˆå‘˜)
   c. æ£€æŸ¥ sys-shop çš„ binding â†’ æ‰¾åˆ°! role='member'
3. ç»“æœ: æå››ç»§æ‰¿ System çš„ member æƒé™ â†’ âœ… å¯ä»¥æŸ¥çœ‹è¯¥ VM
```

### é˜¶æ®µ 2.E: å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿé…ç½® (å¯é€‰) {#stage-2-e}

> **Added 2026-01-26**: å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿé›†æˆé…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.E: å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿé…ç½® (å¯é€‰)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ:                                                                               â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: æ·»åŠ å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿåˆ—è¡¨                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  åç§°              ç±»å‹            çŠ¶æ€         æ“ä½œ                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  OA-å®¡æ‰¹           Webhook         âœ… å¯ç”¨      [ç¼–è¾‘] [ç¦ç”¨] [åˆ é™¤]             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ServiceNow        ServiceNow      âšª ç¦ç”¨      [ç¼–è¾‘] [å¯ç”¨] [åˆ é™¤]             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [+ æ·»åŠ å®¡æ‰¹ç³»ç»Ÿ]                                                                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: é…ç½® Webhook ç±»å‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  æ·»åŠ å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ - Webhook                                                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  åç§°:         [OA-å®¡æ‰¹                      ]                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ç±»å‹:         ( ) Webhook   (â—) ServiceNow   ( ) Jira                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€ Webhook é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Webhook URL:  [https://oa.company.com/api/approval/callback                ]   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Secret:       [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                                ] ğŸ‘               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  è‡ªå®šä¹‰ Headers (JSON):                                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  {                                                                        â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚    "X-API-Key": "your-api-key",                                          â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚    "X-Tenant-ID": "company-001"                                          â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  }                                                                        â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  è¶…æ—¶ (ç§’):    [30             ]                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  é‡è¯•æ¬¡æ•°:     [3              ]                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [æµ‹è¯•è¿æ¥]  [ä¿å­˜]                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  INSERT INTO external_approval_systems                                            â”‚       â”‚
â”‚  â”‚    (id, name, type, enabled, webhook_url, webhook_secret, webhook_headers,        â”‚       â”‚
â”‚  â”‚     timeout_seconds, retry_count, created_by, created_at)                         â”‚       â”‚
â”‚  â”‚  VALUES                                                                            â”‚       â”‚
â”‚  â”‚    ('eas-001', 'OA-å®¡æ‰¹', 'webhook', true,                                         â”‚       â”‚
â”‚  â”‚     'https://oa.company.com/api/approval/callback',                                â”‚       â”‚
â”‚  â”‚     'encrypted:AES256:xxxx',                   -- åŠ å¯†å­˜å‚¨                          â”‚       â”‚
â”‚  â”‚     '{"X-API-Key": "xxx", "X-Tenant-ID": "company-001"}',                          â”‚       â”‚
â”‚  â”‚     30, 3, 'admin', NOW());                                                        â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å®¡è®¡æ—¥å¿—                                                                         â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id, details)   â”‚       â”‚
â”‚  â”‚  VALUES ('external_approval_system.create', 'admin',                               â”‚       â”‚
â”‚  â”‚          'external_approval_system', 'eas-001',                                    â”‚       â”‚
â”‚  â”‚          '{"name": "OA-å®¡æ‰¹", "type": "webhook", "url": "https://oa.company.com..."}');  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ æ•æ„Ÿæ•°æ®åŠ å¯†:                                                                             â”‚
â”‚  - webhook_secret ä½¿ç”¨ AES-256-GCM åŠ å¯†å­˜å‚¨                                                  â”‚
â”‚  - è§£å¯†å¯†é’¥æ¥è‡ªç¯å¢ƒå˜é‡ ENCRYPTION_KEY                                                        â”‚
â”‚  - æ—¥å¿—ä¸­ä¸è®°å½•æ•æ„Ÿå­—æ®µå€¼                                                                      â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<a id="stage-3"></a>

---

```
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 3: ç®¡ç†å‘˜é…ç½® (Cluster/InstanceSize/Template)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜:                                                                                  â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 1: æ³¨å†Œé›†ç¾¤ (ç³»ç»Ÿè‡ªåŠ¨æ¢æµ‹èƒ½åŠ›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç®¡ç†å‘˜åªéœ€æä¾›:                                                                          â”‚ â”‚
â”‚  â”‚  POST /api/v1/admin/clusters                                                             â”‚ â”‚
â”‚  â”‚  { "name": "cluster-a", "kubeconfig": "...", "environment": "prod" }                     â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç³»ç»Ÿè‡ªåŠ¨æ¢æµ‹ (å‚è€ƒ ADR-0014)ï¼Œç®¡ç†å‘˜æ— éœ€æ‰‹åŠ¨é…ç½®:                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  æ¢æµ‹é¡¹ç›®          æ¢æµ‹æ–¹å¼                                     ç»“æœç¤ºä¾‹              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  GPU è®¾å¤‡          node.status.capacity (nvidia.com/gpu)        nvidia.com/gpu: 2    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    ğŸ’¡ éœ€é›†ç¾¤é¢„è£… NVIDIA Device Plugin                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Hugepages         node.status.allocatable                      hugepages-2Mi: 4Gi   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    (hugepages-2Mi, hugepages-1Gi)               hugepages-1Gi: 2Gi   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    ğŸ’¡ å¯èƒ½ä¸ºç©º (æœªé…ç½® Hugepages æ—¶)                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  SR-IOV ç½‘ç»œ       kubectl get net-attach-def -A                sriov-net-1          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    (NetworkAttachmentDefinition CRD)            sriov-net-2          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    ğŸ’¡ éœ€é›†ç¾¤é¢„è£… Multus CNI + SR-IOV Device Plugin                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  StorageClass      kubectl get storageclasses                   ceph-rbd, local-path â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  KubeVirt ç‰ˆæœ¬     kubevirt.status.observedKubeVirtVersion      v1.2.0               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    kubectl get kv -n kubevirt -o jsonpath=                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    '{.items[0].status.observedKubeVirtVersion}'                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ¢æµ‹ç»“æœè‡ªåŠ¨å­˜å‚¨ (ç®¡ç†å‘˜å¯æŸ¥çœ‹ï¼Œä½†æ— éœ€æ‰‹åŠ¨è¾“å…¥):                                           â”‚ â”‚
â”‚  â”‚  cluster.detected_capabilities = {                                                       â”‚ â”‚
â”‚  â”‚      "gpu_devices": ["nvidia.com/GA102GL_A10"],                                          â”‚ â”‚
â”‚  â”‚      "hugepages": ["2Mi", "1Gi"],                                                        â”‚ â”‚
â”‚  â”‚      "sriov_networks": ["sriov-net-1"],                                                  â”‚ â”‚
â”‚  â”‚      "storage_classes": ["ceph-rbd", "local-path"],                                      â”‚ â”‚
â”‚  â”‚      "kubevirt_version": "v1.2.0"                                                        â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 2: é…ç½® Namespace (ADR-0017 åˆè§„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  âš ï¸ æ ¸å¿ƒåŸåˆ™ (ADR-0017):                                                                  â”‚ â”‚
â”‚  â”‚  - Namespace æ˜¯**å…¨å±€é€»è¾‘å®ä½“**ï¼Œä¸ç»‘å®šåˆ°ç‰¹å®šé›†ç¾¤                                           â”‚ â”‚
â”‚  â”‚  - å®é™… K8s namespace åœ¨å®¡æ‰¹é€šè¿‡çš„ VM éƒ¨ç½²æ—¶ JIT (å³æ—¶) åˆ›å»º                                â”‚ â”‚
â”‚  â”‚  - **VM è¯·æ±‚æäº¤å Namespace ä¸å¯å˜**                                                      â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  å¹³å°èŒè´£è¾¹ç•Œ:                                                                            â”‚ â”‚
â”‚  â”‚  - âœ… ç®¡ç†é€»è¾‘ namespace æ³¨å†Œè¡¨ï¼ˆç¯å¢ƒæ ‡ç­¾ã€æ‰€æœ‰æƒï¼‰                                          â”‚ â”‚
â”‚  â”‚  - âŒ ä¸ç®¡ç†: Kubernetes RBAC / ResourceQuota (ç”± K8s ç®¡ç†å‘˜è´Ÿè´£)                        â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç®¡ç†å‘˜æ“ä½œï¼ˆæ³¨å†Œé€»è¾‘ namespaceï¼‰:                                                         â”‚ â”‚
â”‚  â”‚  POST /api/v1/admin/namespaces                    ğŸ‘ˆ éé›†ç¾¤ç»‘å®š                           â”‚ â”‚
â”‚  â”‚  {                                                                                       â”‚ â”‚
â”‚  â”‚      "name": "prod-shop",                                                                â”‚ â”‚
â”‚  â”‚      "environment": "prod",                       ğŸ‘ˆ å†³å®šå®¡æ‰¹ç­–ç•¥å’Œé›†ç¾¤åŒ¹é…                 â”‚ â”‚
â”‚  â”‚      "owner_id": "user-001"                                                              â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ’¡ æç¤º: ç”¨æˆ·é€‰æ‹© Namespace æ—¶ï¼Œç³»ç»Ÿæ ¹æ® environment æ ‡ç­¾ç¡®å®š:                            â”‚ â”‚
â”‚  â”‚     - å®¡æ‰¹ç­–ç•¥ (test ç¯å¢ƒå¯å¿«é€Ÿå®¡æ‰¹ï¼Œprod ç¯å¢ƒéœ€ä¸¥æ ¼å®¡æ‰¹)                                   â”‚ â”‚
â”‚  â”‚     - è¶…å–è­¦å‘Š (prod ç¯å¢ƒè¶…å–æ—¶æ˜¾ç¤ºè­¦å‘Š)                                                   â”‚ â”‚
â”‚  â”‚     - é›†ç¾¤åŒ¹é… (namespace ç¯å¢ƒç±»å‹å¿…é¡»ä¸é›†ç¾¤ç¯å¢ƒç±»å‹åŒ¹é…: testâ†’test, prodâ†’prod)            â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ’¡ JIT Namespace åˆ›å»ºï¼ˆå®¡æ‰¹æ‰§è¡Œé˜¶æ®µï¼‰:                                                    â”‚ â”‚
â”‚  â”‚     ç®¡ç†å‘˜å®¡æ‰¹ VM è¯·æ±‚å¹¶é€‰æ‹©ç›®æ ‡é›†ç¾¤å:                                                     â”‚ â”‚
â”‚  â”‚     1. æ£€æŸ¥ç›®æ ‡é›†ç¾¤ä¸Šæ˜¯å¦å­˜åœ¨ K8s namespace                                                â”‚ â”‚
â”‚  â”‚     2. å¦‚ä¸å­˜åœ¨ â†’ åˆ›å»ºå¸¦æœ‰æ ‡å‡†æ ‡ç­¾çš„ namespace                                             â”‚ â”‚
â”‚  â”‚     3. é”™è¯¯å¤„ç†ï¼ˆK8s API é”™è¯¯è¢«åˆ†ç±»åæŠ¥å‘Šï¼‰:                                               â”‚ â”‚
â”‚  â”‚        - æƒé™ä¸è¶³ â†’ NAMESPACE_PERMISSION_DENIED (403)                                     â”‚ â”‚
â”‚  â”‚        - ResourceQuota è¶…é™ â†’ NAMESPACE_QUOTA_EXCEEDED (403) Â¹                            â”‚ â”‚
â”‚  â”‚        - å…¶ä»–é”™è¯¯ â†’ NAMESPACE_CREATION_FAILED (500)                                       â”‚ â”‚
â”‚  â”‚     è¯¦è§ ADR-0017 Â§142-221 å®Œæ•´ JIT åˆ›å»ºæµç¨‹ã€‚                                            â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚     Â¹ K8s å¯èƒ½å› é›†ç¾¤ ResourceQuota ç­–ç•¥æ‹’ç»åˆ›å»º namespaceã€‚                                â”‚ â”‚
â”‚  â”‚       å¹³å°åªæŠ¥å‘Šæ­¤é”™è¯¯ï¼Œä¸è´Ÿè´£ç®¡ç† K8s é…é¢ã€‚                                              â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 3: é…ç½® Template (å‚è€ƒ ADR-0015 Â§5, Â§17) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ¨¡æ¿å®šä¹‰ VM çš„æ“ä½œç³»ç»ŸåŸºç¡€é…ç½®:                                                            â”‚ â”‚
â”‚  â”‚  - OS é•œåƒæ¥æº (DataVolume / PVC å¼•ç”¨)                                                    â”‚ â”‚
â”‚  â”‚  - cloud-init é…ç½® (ç®¡ç†å‘˜å¯è‡ªå®šä¹‰)                                                        â”‚ â”‚
â”‚  â”‚  - å­—æ®µå¯è§æ€§æ§åˆ¶ (quick_fields / advanced_fields)                                        â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ’¡ æ³¨æ„: ç¡¬ä»¶èƒ½åŠ›è¦æ±‚ (GPU/SR-IOV/Hugepages) å·²ç§»è‡³ InstanceSize é…ç½®                     â”‚ â”‚
â”‚  â”‚  ğŸ’¡ ç³»ç»Ÿåˆå§‹åŒ–æ—¶ä¼šé¢„å¡«å……å¸¸ç”¨æ¨¡æ¿ (ä» seed data å¯¼å…¥åˆ° PostgreSQL)                           â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ›å»ºæ¨¡æ¿                                                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  åç§°:         [centos7-standard    ]                                              â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ†ç±»:         [æ“ä½œç³»ç»Ÿ â–¼]                                                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  çŠ¶æ€:         [active â–¼]                                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ é•œåƒæ¥æº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ç±»å‹:         (â—) containerdisk   ( ) pvc                                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€ containerdisk æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  é•œåƒåœ°å€:   [docker.io/kubevirt/centos:7                    ]             â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€ pvc æ¨¡å¼ (åˆ‡æ¢åæ˜¾ç¤º) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Namespace:  [default           ]                                          â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  PVC åç§°:   [centos7-base-disk ]                                          â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ cloud-init é…ç½® (YAML) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  #cloud-config                                                             â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  users:                                                                    â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    - name: admin                                                           â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚      sudo: ALL=(ALL) NOPASSWD:ALL                                          â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  chpasswd:                                                                 â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    expire: true                         ğŸ‘ˆ é¦–æ¬¡ç™»å½•åå¼ºåˆ¶ä¿®æ”¹å¯†ç             â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    users:                                                                  â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚      - name: admin                                                         â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚        password: changeme123            ğŸ‘ˆ ä¸€æ¬¡æ€§åˆå§‹å¯†ç                     â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ’¡ å¹³å°èŒè´£: æä¾›ä¸€æ¬¡æ€§å¯†ç ç¡®ä¿é¦–æ¬¡ç™»å½•                                            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ’¡ åç»­ç®¡ç†: ç”±ç”¨æˆ·/ç®¡ç†å‘˜/å ¡å’æœºè´Ÿè´£ (å¯é€šè¿‡è‡ªå®šä¹‰ cloud-init å¯¹æ¥)               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [ä¿å­˜]                                                                            â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ¨¡æ¿ç‰ˆæœ¬è¯´æ˜ (ADR-0015 Â§17):                                                            â”‚ â”‚
â”‚  â”‚  - ç”¨æˆ·æäº¤è¯·æ±‚æ—¶çœ‹åˆ°å½“å‰æ´»è·ƒç‰ˆæœ¬                                                          â”‚ â”‚
â”‚  â”‚  - ç®¡ç†å‘˜å®¡æ‰¹æ—¶å¯é€‰æ‹©ä¸åŒç‰ˆæœ¬                                                              â”‚ â”‚
â”‚  â”‚  - æœ€ç»ˆæ¨¡æ¿å†…å®¹å¿«ç…§åˆ° ApprovalTicketï¼ŒVM åˆ›å»ºåä¸å—æ¨¡æ¿æ›´æ–°å½±å“                            â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ‘‰ æ™®é€šç”¨æˆ·: é€‰æ‹©æ¨¡æ¿ï¼Œä½†ä¸èƒ½ä¿®æ”¹ cloud-init å†…å®¹                                         â”‚ â”‚
â”‚  â”‚  ğŸ‘‰ ç®¡ç†å‘˜: å¯åˆ›å»º/ç¼–è¾‘æ¨¡æ¿ï¼ŒåŒ…æ‹¬é•œåƒæ¥æºå’Œ cloud-init é…ç½®                                â”‚ â”‚
â”‚  â”‚             (å¦‚éœ€å¯¹æ¥å ¡å’æœºï¼Œç®¡ç†å‘˜å¯è‡ªå®šä¹‰ cloud-init é…ç½®)                               â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 4: åˆ›å»º InstanceSize (é€šè¿‡ Schema é©±åŠ¨çš„è¡¨å•) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç®¡ç†å‘˜çœ‹åˆ°çš„ UI (å‰ç«¯æ ¹æ® Schema è‡ªåŠ¨æ¸²æŸ“):                                               â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ›å»ºInstanceSizeï¼ˆè§„æ ¼ï¼‰                                                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  åç§°:         [gpu-workstation    ]                                              â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  æ˜¾ç¤ºåç§°:     [GPU å·¥ä½œç«™ (8æ ¸ 32GB)]                                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ èµ„æºé…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  CPU æ ¸æ•°:     [8        ]                                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [âœ“] å¯ç”¨ CPU è¶…å–     ğŸ‘ˆ å‹¾é€‰åæ˜¾ç¤º request/limit                                â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”‚  CPU Request: [4    ] æ ¸   CPU Limit: [8    ] æ ¸   (2x è¶…å–)            â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  å†…å­˜:         [32Gi     ]                                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [âœ“] å¯ç”¨å†…å­˜è¶…å–                                                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”‚  Mem Request: [16Gi ] æ ¸   Mem Limit: [32Gi ]   (2x è¶…å–)               â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ é«˜çº§è®¾ç½® â”€â”€                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Hugepages:    [æ—  (None) â–¼]   ğŸ‘ˆ ä¸‹æ‹‰æ¡†é€‰é¡¹æ¥è‡ª KubeVirt Schema enum + é»˜è®¤æ—     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                [æ—  (None) ]    â† é»˜è®¤é€‰é¡¹: ä¸ä½¿ç”¨ Hugepages                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                [2Mi        ]                                                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                [1Gi        ]                                                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ä¸“ç”¨ CPU:     [âœ“]        ğŸ‘ˆ å¤é€‰æ¡† (Schema ç±»å‹: boolean)                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  GPU è®¾å¤‡:                 ğŸ‘ˆ åŠ¨æ€è¡¨æ ¼ (Schema ç±»å‹: array)                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  åç§°       è®¾å¤‡åç§°                                                      â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [gpu1   ]  [nvidia.com/GA102GL_A10         ]  â† ç®¡ç†å‘˜è‡ªå·±è¾“å…¥           â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                                            â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [+ æ·»åŠ  GPU]                                                              â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [ä¿å­˜]                                                                            â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  å­˜å‚¨åˆ° PostgreSQL (åç«¯ä¸ç†è§£å†…å®¹ï¼Œåªå­˜å‚¨ JSON):                                          â”‚ â”‚
â”‚  â”‚  {                                                                                       â”‚ â”‚
â”‚  â”‚      "name": "gpu-workstation",                                                          â”‚ â”‚
â”‚  â”‚      "cpu_overcommit": { "enabled": true, "request": "4", "limit": "8" },                â”‚ â”‚
â”‚  â”‚      "mem_overcommit": { "enabled": true, "request": "16Gi", "limit": "32Gi" },          â”‚ â”‚
â”‚  â”‚      "spec_overrides": {                                                                 â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.cpu.cores": 8,                                       â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.resources.requests.memory": "32Gi",                  â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.memory.hugepages.pageSize": "2Mi",                   â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.cpu.dedicatedCpuPlacement": true,                    â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.devices.gpus": [                                     â”‚ â”‚
â”‚  â”‚              {"name": "gpu1", "deviceName": "nvidia.com/GA102GL_A10"}                    â”‚ â”‚
â”‚  â”‚          ]                                                                               â”‚ â”‚
â”‚  â”‚      }                                                                                   â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## Part 2: èµ„æºç®¡ç†æµç¨‹

> **è¯´æ˜**: ç”¨æˆ·åœ¨åˆ›å»º VM ä¹‹å‰ï¼Œå¿…é¡»å…ˆåˆ›å»º System å’Œ Service æ¥ç»„ç»‡èµ„æºã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4: ç”¨æˆ·åˆ›å»ºç»„ç»‡ç»“æ„                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  é¡ºåº: System â†’ Service â†’ VM                                                                â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  System (ç³»ç»Ÿ)                                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€ Service (æœåŠ¡)                                                                   â”‚ â”‚
â”‚  â”‚    â”‚     â”œâ”€â”€ VM 1                                                                       â”‚ â”‚
â”‚  â”‚    â”‚     â””â”€â”€ VM 2                                                                       â”‚ â”‚
â”‚  â”‚    â””â”€â”€ Service (æœåŠ¡)                                                                   â”‚ â”‚
â”‚  â”‚          â””â”€â”€ VM 3                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4.A: ç”¨æˆ·åˆ›å»ºç³»ç»Ÿ (System)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·æ“ä½œ:                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  åˆ›å»ºç³»ç»Ÿ                                                                          â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  ç³»ç»Ÿåç§°:     [shop                ]    ğŸ‘ˆ å…¨å±€å”¯ä¸€, æœ€é•¿ 15 å­—ç¬¦                   â”‚       â”‚
â”‚  â”‚  ç³»ç»Ÿæè¿°:     [ç”µå•†æ ¸å¿ƒç³»ç»Ÿ          ]    ğŸ‘ˆ æ”¯æŒ Markdown æ ¼å¼                       â”‚       â”‚
â”‚  â”‚               [é¢„è§ˆ] [ä¸Šä¼  .md æ–‡ä»¶]        â† æˆ–ä¸Šä¼ å·²æœ‰ Markdown æ–‡ä»¶                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  [åˆ›å»º]                                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡):                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºç³»ç»Ÿ                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO systems (id, name, description, created_by, created_at)              â”‚       â”‚
â”‚  â”‚  VALUES ('sys-001', 'shop', 'ç”µå•†æ ¸å¿ƒç³»ç»Ÿ', 'zhang.san', NOW());                   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. ç”¨æˆ·æƒé™è‡ªåŠ¨ç»§æ‰¿ (é€šè¿‡ RoleBinding è¡¨, å‚è€ƒ ADR-0015 Â§22)                    â”‚       â”‚
â”‚  â”‚  INSERT INTO role_bindings (user_id, role, resource_type, resource_id)            â”‚       â”‚
â”‚  â”‚  VALUES ('zhang.san', 'owner', 'system', 'sys-001');                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. ğŸ“ è®°å½•å®¡è®¡æ—¥å¿—                                                             â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id, details)   â”‚       â”‚
â”‚  â”‚  VALUES ('system.create', 'zhang.san', 'system', 'sys-001',                       â”‚       â”‚
â”‚  â”‚          '{"name": "shop", "description": "ç”µå•†æ ¸å¿ƒç³»ç»Ÿ"}');                        â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âœ… æ— éœ€å®¡æ‰¹: ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ›å»ºç³»ç»Ÿ                                                          â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ‘† åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºè¯¥ System çš„ Ownerï¼Œæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒ                                            â”‚
â”‚     å…¶ä»–ç”¨æˆ·é»˜è®¤çœ‹ä¸åˆ°æ­¤ System åŠå…¶ä¸‹çš„ Service/VM                                            â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4.A+: èµ„æºçº§æˆå‘˜ç®¡ç† (Owner æ“ä½œ)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ æ ¸å¿ƒè®¾è®¡: èµ„æºåˆ›å»ºè€…å¯ä»¥å°†å…¶ä»–ç”¨æˆ·æ·»åŠ åˆ°è‡ªå·±çš„ System/Service ä¸­                              â”‚
â”‚     æ— éœ€å¹³å°ç®¡ç†å‘˜å‚ä¸ï¼Œå®ç°å›¢é˜Ÿè‡ªæœåŠ¡                                                           â”‚
â”‚                                                                                              â”‚
â”‚  Owner æ“ä½œ (ç³»ç»Ÿè®¾ç½® â†’ æˆå‘˜ç®¡ç†):                                                              â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ç³»ç»Ÿæˆå‘˜ç®¡ç† - shop                                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  å½“å‰æˆå‘˜:                                                                          â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·              è§’è‰²                æ“ä½œ                                  â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  å¼ ä¸‰              Owner (åˆ›å»ºè€…)      -                                     â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  æå››              Admin               [âš™ ç¼–è¾‘] [ğŸ—‘ ç§»é™¤]                     â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  ç‹äº”              Member              [âš™ ç¼–è¾‘] [ğŸ—‘ ç§»é™¤]                     â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  èµµå…­              Viewer              [âš™ ç¼–è¾‘] [ğŸ—‘ ç§»é™¤]                     â”‚   â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  [+ æ·»åŠ æˆå‘˜]                                                                       â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  â”Œâ”€ æ·»åŠ æˆå‘˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚  â”‚  æœç´¢ç”¨æˆ·:   [li.si@company.com      ] ğŸ”                                    â”‚   â”‚       â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  æƒé™è§’è‰²:   [Member â–¼]                                                       â”‚   â”‚       â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  å¯é€‰è§’è‰²:                                                                    â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Owner  - å®Œå…¨æ§åˆ¶ (è½¬è®©æ‰€æœ‰æƒ)                                           â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Admin  - å¯ç®¡ç†æˆå‘˜ã€åˆ›å»º/åˆ é™¤æœåŠ¡å’Œ VM                                   â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Member - å¯åˆ›å»ºæœåŠ¡å’Œ VMï¼Œä¸èƒ½ç®¡ç†æˆå‘˜                                    â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Viewer - åªè¯»è®¿é—®                                                        â”‚   â”‚       â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  [æ·»åŠ ]  [å–æ¶ˆ]                                                               â”‚   â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“è®¾è®¡ (èµ„æºçº§æƒé™):                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- èµ„æºè§’è‰²ç»‘å®šè¡¨ (åŒºåˆ«äºå…¨å±€ role_bindings)                                       â”‚       â”‚
â”‚  â”‚  CREATE TABLE resource_role_bindings (                                            â”‚       â”‚
â”‚  â”‚    id VARCHAR PRIMARY KEY,                                                        â”‚       â”‚
â”‚  â”‚    user_id VARCHAR NOT NULL,                                                      â”‚       â”‚
â”‚  â”‚    role VARCHAR NOT NULL,          -- owner, admin, member, viewer                â”‚       â”‚
â”‚  â”‚    resource_type VARCHAR NOT NULL, -- system, service, vm                         â”‚       â”‚
â”‚  â”‚    resource_id VARCHAR NOT NULL,   -- å…·ä½“èµ„æº ID                                  â”‚       â”‚
â”‚  â”‚    granted_by VARCHAR NOT NULL,    -- æˆæƒäºº                                       â”‚       â”‚
â”‚  â”‚    created_at TIMESTAMP                                                           â”‚       â”‚
â”‚  â”‚  );                                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- ç¤ºä¾‹: å¼ ä¸‰æŠŠæå››æ·»åŠ ä¸º shop ç³»ç»Ÿçš„ Admin                                        â”‚       â”‚
â”‚  â”‚  INSERT INTO resource_role_bindings                                               â”‚       â”‚
â”‚  â”‚    (id, user_id, role, resource_type, resource_id, granted_by, created_at)        â”‚       â”‚
â”‚  â”‚  VALUES                                                                           â”‚       â”‚
â”‚  â”‚    ('rrb-001', 'user-002', 'admin', 'system', 'sys-001', 'user-001', NOW());      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” æƒé™ç»§æ‰¿æ¨¡å‹ (å‚è€ƒ: Google Cloud IAM, GitHub Teams):                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  â­ æ ¸å¿ƒåŸåˆ™: å­èµ„æºå®Œå…¨ç»§æ‰¿çˆ¶èµ„æºçš„æƒé™                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  â”Œâ”€ æƒé™åªéœ€è¦åœ¨ System å±‚é…ç½®ä¸€æ¬¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚
â”‚  â”‚  â”‚                                                                                â”‚ â”‚       â”‚
â”‚  â”‚  â”‚  System (shop)                    â† åœ¨è¿™é‡Œæ·»åŠ æˆå‘˜                              â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”œâ”€ Admin: æå››                                                             â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”œâ”€ Member: ç‹äº”, èµµå…­                                                       â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚                                                                           â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”œâ”€â”€ Service (redis)            â† è‡ªåŠ¨ç»§æ‰¿æå››ã€ç‹äº”ã€èµµå…­çš„æƒé™              â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚     â”œâ”€â”€ VM (redis-01)        â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚     â””â”€â”€ VM (redis-02)        â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚                                                                           â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â””â”€â”€ Service (mysql)            â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚          â””â”€â”€ VM (mysql-01)        â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚                                                                                â”‚ â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  âœ… å¥½å¤„:                                                                           â”‚       â”‚
â”‚  â”‚    - æ·»åŠ /ç§»é™¤æˆå‘˜åªéœ€ä¿®æ”¹ Systemï¼ŒService å’Œ VM è‡ªåŠ¨ç”Ÿæ•ˆ                            â”‚       â”‚
â”‚  â”‚    - é¿å…äº†ç»´æŠ¤å‡ åä¸ª Service/VM çš„æˆå‘˜é…ç½®                                          â”‚       â”‚
â”‚  â”‚    - ä¸ Google Cloud IAM å’Œ GitHub çš„ç»§æ‰¿æ¨¡å‹ä¸€è‡´                                   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” æƒé™æ£€æŸ¥ç®—æ³•:                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  ç”¨æˆ·è¯·æ±‚è®¿é—®èµ„æº R:                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  1. å…¨å±€æƒé™æ£€æŸ¥:                                                                  â”‚       â”‚
â”‚  â”‚     - æ‹¥æœ‰ platform:admin æƒé™ â†’ ç›´æ¥å…è®¸ï¼ˆæ˜¾å¼è¶…çº§ç®¡ç†å‘˜ï¼‰                      â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  2. èµ„æºçº§æƒé™æ£€æŸ¥ (å‘ä¸Šéå†ç»§æ‰¿é“¾):                                                 â”‚       â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚
â”‚  â”‚     â”‚  è®¿é—® VM (vm-001):                                                        â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    1. æ£€æŸ¥ vm-001 çš„ resource_role_binding â†’ æœªæ‰¾åˆ°                        â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    2. å‘ä¸Š: æ£€æŸ¥æ‰€å± Service (svc-001) çš„ binding â†’ æœªæ‰¾åˆ°                  â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    3. å†å‘ä¸Š: æ£€æŸ¥æ‰€å± System (sys-001) çš„ binding â†’ æ‰¾åˆ°! role=member     â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    4. è¿”å› role=member çš„æƒé™ â†’ âœ… å…è®¸æŸ¥çœ‹                                 â”‚ â”‚       â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  ä¼ªä»£ç :                                                                           â”‚       â”‚
â”‚  â”‚  ```                                                                               â”‚       â”‚
â”‚  â”‚  func checkPermission(user, resource) Role:                                        â”‚       â”‚
â”‚  â”‚      current = resource                                                            â”‚       â”‚
â”‚  â”‚      while current != nil:                                                         â”‚       â”‚
â”‚  â”‚          binding = findBinding(user, current)                                      â”‚       â”‚
â”‚  â”‚          if binding != nil:                                                        â”‚       â”‚
â”‚  â”‚              return binding.role                                                   â”‚       â”‚
â”‚  â”‚          current = current.parent  // VMâ†’Serviceâ†’Systemâ†’nil                        â”‚       â”‚
â”‚  â”‚      return nil  // æ— æƒé™ï¼Œèµ„æºä¸å¯è§                                              â”‚       â”‚
â”‚  â”‚  ```                                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“Š æƒé™çŸ©é˜µ (ç»§æ‰¿è‡ª System çš„è§’è‰²):                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚       â”‚
â”‚  â”‚     â”‚ æ“ä½œ       â”‚ Owner  â”‚ Admin  â”‚ Member â”‚ Viewer â”‚                            â”‚       â”‚
â”‚  â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚       â”‚
â”‚  â”‚     â”‚ æŸ¥çœ‹èµ„æº   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ åˆ›å»ºå­èµ„æº â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ ä¿®æ”¹èµ„æº   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ åˆ é™¤èµ„æº   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ ç®¡ç†æˆå‘˜   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚  â† ä»…åœ¨ System å±‚å¯æ“ä½œ       â”‚       â”‚
â”‚  â”‚     â”‚ è½¬è®©æ‰€æœ‰æƒ â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ è®¾è®¡è¯´æ˜:                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â€¢ Service å’Œ VM å±‚ä¸å•ç‹¬é…ç½®æˆå‘˜ï¼Œæƒé™å®Œå…¨ç»§æ‰¿è‡ª System                            â”‚       â”‚
â”‚  â”‚  â€¢ ä»¥ System ä¸ºå•ä½ç®¡ç†æƒé™ï¼Œç®€åŒ–è¿ç»´                                               â”‚       â”‚
â”‚  â”‚  â€¢ å¦‚éœ€æ›´ç»†ç²’åº¦éš”ç¦»ï¼Œå¯å°†èµ„æºæ‹†åˆ†åˆ°ä¸åŒ System                                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âš ï¸ æƒé™è¾¹ç•Œ:                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  Shepherd æ²»ç†å¹³å°è´Ÿè´£:                                                             â”‚       â”‚
â”‚  â”‚    âœ… è°å¯ä»¥çœ‹åˆ°è¿™äº› VM (å¯è§æ€§)                                                    â”‚       â”‚
â”‚  â”‚    âœ… è°å¯ä»¥åˆ›å»º/å¯åœ/åˆ é™¤ VM (ç”Ÿå‘½å‘¨æœŸç®¡ç†)                                         â”‚       â”‚
â”‚  â”‚    âœ… è°å¯ä»¥é€šè¿‡ VNC æ§åˆ¶å°è®¿é—® (Web æ§åˆ¶å°)                                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  Shepherd ä¸è´Ÿè´£:                                                                   â”‚       â”‚
â”‚  â”‚    âŒ è°å¯ä»¥ SSH/RDP ç™»å½• VM (ç”±ä¼ä¸šå ¡å’æœºæ§åˆ¶)                                      â”‚       â”‚
â”‚  â”‚    âŒ VM å†…éƒ¨çš„ç”¨æˆ·æƒé™ç®¡ç† (ç”± OS è‡ªèº«ç®¡ç†)                                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  å…¸å‹ä¼ä¸šæ¶æ„:                                                                       â”‚       â”‚
â”‚  â”‚    ç”¨æˆ· â†’ å ¡å’æœº (è®¤è¯/å®¡è®¡/å½•å±) â†’ VM                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4.B: ç”¨æˆ·åˆ›å»ºæœåŠ¡ (Service)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·æ“ä½œ:                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  åˆ›å»ºæœåŠ¡                                                                          â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  æ‰€å±ç³»ç»Ÿ:     [shop â–¼]                                                             â”‚       â”‚
â”‚  â”‚  æœåŠ¡åç§°:     [redis              ]    ğŸ‘ˆ ç³»ç»Ÿå†…å”¯ä¸€, æœ€é•¿ 15 å­—ç¬¦                  â”‚       â”‚
â”‚  â”‚  æœåŠ¡æè¿°:     [ç¼“å­˜æœåŠ¡            ]    ğŸ‘ˆ æ”¯æŒ Markdown æ ¼å¼                       â”‚       â”‚
â”‚  â”‚               [é¢„è§ˆ] [ä¸Šä¼  .md æ–‡ä»¶]        â† æˆ–ä¸Šä¼ å·²æœ‰ Markdown æ–‡ä»¶                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  [åˆ›å»º]                                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡):                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºæœåŠ¡                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO services (id, name, description, system_id, created_by, created_at)  â”‚       â”‚
â”‚  â”‚  VALUES ('svc-001', 'redis', 'ç¼“å­˜æœåŠ¡', 'sys-001', 'zhang.san', NOW());           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. æƒé™è‡ªåŠ¨ç»§æ‰¿è‡ª System (ä¸éœ€è¦é¢å¤– RoleBinding)                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. ğŸ“ è®°å½•å®¡è®¡æ—¥å¿—                                                             â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id,            â”‚       â”‚
â”‚  â”‚                          parent_type, parent_id, details) VALUES                  â”‚       â”‚
â”‚  â”‚    ('service.create', 'zhang.san', 'service', 'svc-001', 'system', 'sys-001',     â”‚       â”‚
â”‚  â”‚     '{"name": "redis", "description": "ç¼“å­˜æœåŠ¡"}');                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âœ… æ— éœ€å®¡æ‰¹: ç³»ç»Ÿæˆå‘˜å¯ä»¥åˆ›å»ºæœåŠ¡                                                             â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 3: VM ç”Ÿå‘½å‘¨æœŸæµç¨‹

> **è¯´æ˜**: æœ¬èŠ‚æè¿° VM çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºè¯·æ±‚ â†’ å®¡æ‰¹ â†’ æ‰§è¡Œ â†’ è¿è¡Œ â†’ åˆ é™¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 5.A: ç”¨æˆ·æäº¤ VM è¯·æ±‚                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  æ™®é€šç”¨æˆ·:                                                                                    â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æäº¤ VM åˆ›å»ºè¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç”¨æˆ·çœ‹åˆ°çš„ç•Œé¢:                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ›å»ºè™šæ‹Ÿæœº                                                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  æ‰€å±æœåŠ¡:     [shop / redis â–¼]                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  å‘½åç©ºé—´:     [prod-shop â–¼]                                                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  æ¨¡æ¿:         [centos7-docker â–¼]                                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  InstanceSizeï¼ˆè§„æ ¼ï¼‰:         [gpu-workstation â–¼]                                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€ InstanceSizeï¼ˆè§„æ ¼ï¼‰è¯¦æƒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  CPU: 8 æ ¸   å†…å­˜: 32 GB                                                      â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  âš ï¸ æ­¤InstanceSizeï¼ˆè§„æ ¼ï¼‰åŒ…å« GPU: nvidia.com/GA102GL_A10                                    â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚     è¯·ç¡®è®¤æ‚¨çš„ä¸šåŠ¡ç¡®å®éœ€è¦ GPU èµ„æº                                             â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ å¿«é€Ÿé…ç½® â”€â”€                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ç£ç›˜å¤§å°:     [====â—==========] [100] GB   ğŸ‘ˆ é»˜è®¤å€¼æ¥è‡ªInstanceSizeï¼ˆè§„æ ¼ï¼‰é¢„è®¾                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                 50 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 500           ç”¨æˆ·å¯é€šè¿‡æ»‘å—æˆ–è¾“å…¥æ¡†è°ƒæ•´             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ç”³è¯·ç†ç”±:     [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²                ]                                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [æäº¤ç”³è¯·]                                                                         â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ‘† InstanceSizeï¼ˆè§„æ ¼ï¼‰ä¸‹æ‹‰æ¡†æ˜¾ç¤ºå…³é”®ä¿¡æ¯:                                                               â”‚ â”‚
â”‚  â”‚     - æ™®é€šInstanceSizeï¼ˆè§„æ ¼ï¼‰: "medium (4æ ¸ 8GB)" â†’ ç”¨æˆ·çœ‹åˆ° CPU å’Œå†…å­˜                                 â”‚ â”‚
â”‚  â”‚     - GPU InstanceSizeï¼ˆè§„æ ¼ï¼‰: "gpu-workstation (8æ ¸ 32GB)" + âš ï¸GPU æç¤º â†’ æé†’ç”¨æˆ·ç¡®è®¤æ˜¯å¦éœ€è¦         â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 5.B: ç®¡ç†å‘˜å®¡æ‰¹                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜:                                                                                  â”‚
â”‚                                                                                              â”‚
â”‚  ç³»ç»Ÿæ ¹æ® InstanceSize.spec_overrides æå–èµ„æºéœ€æ±‚ï¼ŒåŒ¹é…é›†ç¾¤èƒ½åŠ›:                              â”‚
â”‚                                                                                              â”‚
â”‚  1. æå–èµ„æºéœ€æ±‚:                                                                             â”‚
â”‚     - GPU: nvidia.com/GA102GL_A10                                                            â”‚
â”‚     - Hugepages: hugepages-2Mi                                                               â”‚
â”‚                                                                                              â”‚
â”‚  2. åŒ¹é…é›†ç¾¤:                                                                                 â”‚
â”‚     - Cluster-A: æ”¯æŒ nvidia.com/GA102GL_A10, hugepages-2Mi â†’ âœ… åŒ¹é…                        â”‚
â”‚     - Cluster-B: ä¸æ”¯æŒ GPU â†’ âŒ è¿‡æ»¤                                                         â”‚
â”‚                                                                                              â”‚
â”‚  3. ç®¡ç†å‘˜å®¡æ‰¹ç•Œé¢:                                                                           â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å®¡æ‰¹ VM è¯·æ±‚                                                                              â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  è¯·æ±‚è¯¦æƒ…:                                                                                 â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚  ç”³è¯·äºº:       zhang.san                                                                   â”‚ â”‚
â”‚  â”‚  å‘½åç©ºé—´:     prod-shop              ğŸ‘ˆ ç”Ÿäº§ç¯å¢ƒ                                          â”‚ â”‚
â”‚  â”‚  æœåŠ¡:         shop/redis                                                                  â”‚ â”‚
â”‚  â”‚  InstanceSizeï¼ˆè§„æ ¼ï¼‰:         gpu-workstation (8æ ¸ 32GB)                                                  â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  â”€â”€ ç£ç›˜é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚  ç£ç›˜å¤§å°:     [100     ] GB   (ç”¨æˆ·ç”³è¯·å€¼: 100GB, InstanceSizeï¼ˆè§„æ ¼ï¼‰èŒƒå›´: 50-500GB)                      â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  â”€â”€ èµ„æºåˆ†é… (InstanceSizeï¼ˆè§„æ ¼ï¼‰å«è¶…å–æ—¶æ˜¾ç¤ºï¼Œå¯è¦†ç›–) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  [âœ“] å¯ç”¨è¦†ç›–    ğŸ‘ˆ ç®¡ç†å‘˜å¯è¦†ç›–InstanceSizeï¼ˆè§„æ ¼ï¼‰çš„é»˜è®¤ request/limit å€¼                                  â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  CPU:    Request [4    ] æ ¸    Limit [8    ] æ ¸                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  å†…å­˜:   Request [16Gi ]       Limit [32Gi ]                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  âš ï¸ è­¦å‘Š: ç”Ÿäº§ç¯å¢ƒå¯ç”¨äº†è¶…å–ï¼                 ğŸ‘ˆ ä»…ç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºæ­¤è­¦å‘Š                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     é«˜è´Ÿè½½æ—¶å¯èƒ½å½±å“ VM æ€§èƒ½ã€‚                                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  ğŸš¨ å†²çª: ä¸“ç”¨ CPU ä¸è¶…å–ä¸å…¼å®¹ï¼              ğŸ‘ˆ æ£€æµ‹åˆ°å†²çªæ—¶æ˜¾ç¤º (çº¢è‰²è­¦å‘Š)       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     VM å¾ˆå¯èƒ½æ— æ³•å¯åŠ¨ã€‚è¯·å–æ¶ˆä¸“ç”¨ CPU æˆ–ç¦ç”¨è¶…å–ã€‚                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  é›†ç¾¤:         [cluster-a â–¼]     ğŸ‘ˆ ç³»ç»Ÿå·²è¿‡æ»¤ä¸ç¬¦åˆè¦æ±‚çš„é›†ç¾¤                              â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  [æ‰¹å‡†]  [æ‹’ç»]                                                                            â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ‘† æ˜¾ç¤ºé€»è¾‘:                                                                                 â”‚
â”‚     - ç£ç›˜é…ç½®: å§‹ç»ˆæ˜¾ç¤ºï¼Œç®¡ç†å‘˜å¯è°ƒæ•´                                                          â”‚
â”‚     - èµ„æºåˆ†é… (request/limit): InstanceSizeï¼ˆè§„æ ¼ï¼‰å¯ç”¨è¶…å–æ—¶æ˜¾ç¤ºï¼Œä¸åŒºåˆ†ç¯å¢ƒ                                   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ‘† è­¦å‘Šé€»è¾‘ (ä»…æç¤ºï¼Œä¸é˜»æ­¢å®¡æ‰¹):                                                             â”‚
â”‚     1. request â‰  limit ä¸”ç¯å¢ƒä¸º prod â†’ âš ï¸ é»„è‰²è­¦å‘Š (ç”Ÿäº§ç¯å¢ƒè¶…å–)                              â”‚
â”‚     2. è¶…å– + ä¸“ç”¨ CPU åŒæ—¶å¯ç”¨ â†’ ğŸš¨ çº¢è‰²è­¦å‘Š (ä¸¥é‡å†²çªï¼ŒVM å¾ˆå¯èƒ½æ— æ³•å¯åŠ¨)                    â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 5.C: VM åˆ›å»ºæ‰§è¡Œ                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ:                                                                                â”‚
â”‚                                                                                              â”‚
â”‚  1. ç”Ÿæˆ VM åç§°: prod-shop-shop-redis-01                                                    â”‚
â”‚                                                                                              â”‚
â”‚  2. åˆå¹¶ç”Ÿæˆæœ€ç»ˆ YAML:                                                                        â”‚
â”‚     Template (åŸºç¡€æ¨¡æ¿) + InstanceSize.spec_overrides + ç”¨æˆ·å‚æ•° (disk_gb)                    â”‚
â”‚                                                                                              â”‚
â”‚  3. æ¸²æŸ“è¾“å‡º:                                                                                 â”‚
â”‚     apiVersion: kubevirt.io/v1                                                               â”‚
â”‚     kind: VirtualMachine                                                                     â”‚
â”‚     spec:                                                                                    â”‚
â”‚       template:                                                                              â”‚
â”‚         spec:                                                                                â”‚
â”‚           domain:                                                                            â”‚
â”‚             cpu:                                                                             â”‚
â”‚               cores: 8                                   â† æ¥è‡ª spec_overrides               â”‚
â”‚               dedicatedCpuPlacement: true                â† æ¥è‡ª spec_overrides               â”‚
â”‚             memory:                                                                          â”‚
â”‚               hugepages:                                                                     â”‚
â”‚                 pageSize: 2Mi                            â† æ¥è‡ª spec_overrides               â”‚
â”‚             devices:                                                                         â”‚
â”‚               gpus:                                                                          â”‚
â”‚                 - name: gpu1                             â† æ¥è‡ª spec_overrides               â”‚
â”‚                   deviceName: nvidia.com/GA102GL_A10                                        â”‚
â”‚                                                                                              â”‚
â”‚  4. æäº¤åˆ° K8s é›†ç¾¤                                                                           â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‚æ•°æ¥æºæ€»ç»“

| å‚æ•° | å¡«å†™è€… | æ¥æº | è¯´æ˜ |
|------|--------|------|------|
| **Schema å­—æ®µç±»å‹/é€‰é¡¹** | KubeVirt å®˜æ–¹ | JSON Schema | å¼€å‘è€…ä¸å®šä¹‰ï¼Œç›´æ¥ä½¿ç”¨å®˜æ–¹ Schema |
| **Mask è·¯å¾„** | å¼€å‘è€… | config/mask.yaml | åªæŒ‡å®šæš´éœ²å“ªäº›è·¯å¾„ |
| **InstanceSize å…·ä½“å€¼** | ç®¡ç†å‘˜ | Admin UI (Schema é©±åŠ¨) | ç®¡ç†å‘˜æ ¹æ® UI å¡«å†™ï¼Œå­˜ä¸º spec_overrides |
| **Cluster/StorageClass** | ç®¡ç†å‘˜ | å®¡æ‰¹æ—¶é€‰æ‹© | ç³»ç»Ÿè‡ªåŠ¨è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„é›†ç¾¤ |
| **VM Name/Labels** | ç³»ç»Ÿ | è‡ªåŠ¨ç”Ÿæˆ | ç”¨æˆ·ä¸å¯å¹²é¢„ |

### ä¸ä¹‹å‰è®¾è®¡çš„å…³é”®åŒºåˆ«

| æ–¹é¢ | ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰ | ç°åœ¨ï¼ˆæ­£ç¡®ï¼‰ |
|------|-------------|-------------|
| **å­—æ®µé€‰é¡¹æ¥æº** | å¼€å‘è€…åœ¨ Mask ä¸­å®šä¹‰ | KubeVirt å®˜æ–¹ Schema |
| **å­˜å‚¨ç»“æ„** | `requirements map[string]string` | `spec_overrides map[string]interface{}` |
| **UI æ¸²æŸ“** | å¼€å‘è€…é¢„å®šä¹‰ä¸‹æ‹‰æ¡†é€‰é¡¹ | å‰ç«¯æ ¹æ® Schema ç±»å‹è‡ªåŠ¨æ¸²æŸ“ |
| **åç«¯èŒè´£** | åš KV å­é›†åŒ¹é… | åªå­˜å‚¨ JSONï¼Œæå–èµ„æºåšåŒ¹é… |

---

### é˜¶æ®µ 5.A (ç»­): VM åˆ›å»ºè¯·æ±‚ - æ•°æ®åº“æ“ä½œ

> **è¯´æ˜**: ç”¨æˆ·æäº¤ VM è¯·æ±‚åçš„æ•°æ®åº“äº‹åŠ¡å¤„ç†
>
> **âš ï¸ ADR åˆè§„è¦æ±‚**:
> - [ADR-0009](../../../../adr/ADR-0009-domain-event-pattern.md): é¢†åŸŸäº‹ä»¶å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­åˆ›å»º
> - [ADR-0012](../../../../adr/ADR-0012-hybrid-transaction.md): åŸå­æ€§ Ent + sqlc äº‹åŠ¡
>
> **å®¡è®¡æ—¥å¿— vs é¢†åŸŸäº‹ä»¶**:
> - `audit_logs`: äººç±»å¯è¯»çš„åˆè§„è®°å½• (è°åœ¨ä½•æ—¶åšäº†ä»€ä¹ˆ)
> - `domain_events`: æœºå™¨å¯è¯»çš„çŠ¶æ€æµè½¬ (ç³»ç»Ÿé‡æ”¾/æŠ•å½±)
> äºŒè€…å‡ä¸ºå¿…é¡»ï¼ŒåŠŸèƒ½äº’è¡¥ï¼Œä¸å¯æ›¿ä»£ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æäº¤ VM è¯·æ±‚ - æ•°æ®åº“æ“ä½œ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·ç‚¹å‡» [æäº¤ç”³è¯·] æŒ‰é’®:                                                                     â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡ - ADR-0012):                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºé¢†åŸŸäº‹ä»¶ (ADR-0009) ğŸ‘ˆ å¿…é¡»                                              â”‚       â”‚
â”‚  â”‚  INSERT INTO domain_events (                                                      â”‚       â”‚
â”‚  â”‚      id, type, aggregate_type, aggregate_id,                                       â”‚       â”‚
â”‚  â”‚      payload, status, created_at                                                   â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'evt-001',                                                                    â”‚       â”‚
â”‚  â”‚      'VM_CREATE_REQUESTED',             ğŸ‘ˆ äº‹ä»¶ç±»å‹                                 â”‚       â”‚
â”‚  â”‚      'vm', NULL,                        ğŸ‘ˆ èšåˆç±»å‹ (VM å°šæœªåˆ›å»º)                    â”‚       â”‚
â”‚  â”‚      '{"service_id": "svc-001", "instance_size_id": "is-gpu"...}',                â”‚       â”‚
â”‚  â”‚      'PENDING',                         ğŸ‘ˆ ç­‰å¾…å®¡æ‰¹ (ADR-0009 L156)                 â”‚       â”‚
â”‚  â”‚      NOW()                                                                        â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. åˆ›å»ºå®¡æ‰¹å·¥å• (å…³è”äº‹ä»¶)                                                       â”‚       â”‚
â”‚  â”‚  INSERT INTO approval_tickets (                                                   â”‚       â”‚
â”‚  â”‚      id, event_id, type, status, requester_id,                                    â”‚       â”‚
â”‚  â”‚      service_id, namespace, instance_size_id, template_id,                        â”‚       â”‚
â”‚  â”‚      request_params, reason, created_at                                           â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'ticket-001',                                                                â”‚       â”‚
â”‚  â”‚      'evt-001',                         ğŸ‘ˆ å…³è”é¢†åŸŸäº‹ä»¶                             â”‚       â”‚
â”‚  â”‚      'VM_CREATE',                                                                 â”‚       â”‚
â”‚  â”‚      'PENDING_APPROVAL',                ğŸ‘ˆ åˆå§‹çŠ¶æ€: å¾…å®¡æ‰¹                          â”‚       â”‚
â”‚  â”‚      'zhang.san',                                                                 â”‚       â”‚
â”‚  â”‚      'svc-001',                                                                   â”‚       â”‚
â”‚  â”‚      'prod-shop',                                                                 â”‚       â”‚
â”‚  â”‚      'is-gpu-workstation',                                                        â”‚       â”‚
â”‚  â”‚      'tpl-centos7',                                                               â”‚       â”‚
â”‚  â”‚      '{"disk_gb": 100}',                ğŸ‘ˆ ç”¨æˆ·å¯è°ƒæ•´çš„å‚æ•°                         â”‚       â”‚
â”‚  â”‚      'ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²',                                                               â”‚       â”‚
â”‚  â”‚      NOW()                                                                        â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. è®°å½•å®¡è®¡æ—¥å¿— (äººç±»å¯è¯»åˆè§„)                                                   â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (                                                         â”‚       â”‚
â”‚  â”‚      id, action, actor_id, resource_type, resource_id, details, created_at        â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'log-001', 'REQUEST_SUBMITTED', 'zhang.san',                                 â”‚       â”‚
â”‚  â”‚      'approval_ticket', 'ticket-001',                                             â”‚       â”‚
â”‚  â”‚      '{"action": "VM_CREATE", "namespace": "prod-shop"}',                         â”‚       â”‚
â”‚  â”‚      NOW()                                                                        â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 4. å‘é€é€šçŸ¥åˆ°ç®¡ç†å‘˜ (å¯é€‰, æ ¹æ®é…ç½®)                                             â”‚       â”‚
â”‚  â”‚  INSERT INTO notifications (                                                      â”‚       â”‚
â”‚  â”‚      id, recipient_role, type, title, content, related_ticket_id, created_at      â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'notif-001', 'admin', 'APPROVAL_REQUIRED',                                   â”‚       â”‚
â”‚  â”‚      'æ–°çš„ VM åˆ›å»ºè¯·æ±‚', 'ç”¨æˆ· zhang.san ç”³è¯·åˆ›å»º VM...',                          â”‚       â”‚
â”‚  â”‚      'ticket-001', NOW()                                                          â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“Š çŠ¶æ€æµè½¬:                                                                                â”‚
â”‚     - ApprovalTicket: (æ— ) â†’ PENDING_APPROVAL                                                â”‚
â”‚     - DomainEvent: (æ— ) â†’ PENDING                                                            â”‚
â”‚                                                                                              â”‚
â”‚  ğŸš« æ³¨æ„: æ­¤é˜¶æ®µä¸æ’å…¥ River Job (ç­‰å¾…å®¡æ‰¹)                                                    â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é˜¶æ®µ 5.B (ç»­): ç®¡ç†å‘˜å®¡æ‰¹ - æ•°æ®åº“æ“ä½œ

> **è¯´æ˜**: ç®¡ç†å‘˜å®¡æ‰¹/æ‹’ç»è¯·æ±‚åçš„æ•°æ®åº“äº‹åŠ¡å¤„ç†
>
> **âš ï¸ ADR åˆè§„è¦æ±‚**:
> - [ADR-0006](../../../../adr/ADR-0006-unified-async-model.md): River Job å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­æ’å…¥
> - [ADR-0009](../../../../adr/ADR-0009-domain-event-pattern.md): DomainEvent çŠ¶æ€å¿…é¡»æ›´æ–°
> - [ADR-0012](../../../../adr/ADR-0012-hybrid-transaction.md): åŸå­æ€§ Ent + sqlc + River InsertTx

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç®¡ç†å‘˜æ‰¹å‡† VM è¯·æ±‚ - æ•°æ®åº“æ“ä½œ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç®¡ç†å‘˜ç‚¹å‡» [æ‰¹å‡†] æŒ‰é’®:                                                                       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡ - ADR-0012):                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. æ›´æ–°å·¥å•çŠ¶æ€                                                                 â”‚       â”‚
â”‚  â”‚  UPDATE approval_tickets SET                                                      â”‚       â”‚
â”‚  â”‚      status = 'APPROVED',                  ğŸ‘ˆ çŠ¶æ€å˜æ›´: PENDING â†’ APPROVED         â”‚       â”‚
â”‚  â”‚      approver_id = 'admin.li',                                                    â”‚       â”‚
â”‚  â”‚      approved_at = NOW(),                                                         â”‚       â”‚
â”‚  â”‚      selected_cluster_id = 'cluster-a',     ğŸ‘ˆ ç®¡ç†å‘˜é€‰æ‹©çš„é›†ç¾¤ (ADR-0017)            â”‚       â”‚
â”‚  â”‚      selected_storage_class = 'ceph-rbd',   ğŸ‘ˆ ç®¡ç†å‘˜é€‰æ‹©çš„å­˜å‚¨ç±»                      â”‚       â”‚
â”‚  â”‚      template_snapshot = '{...}',          ğŸ‘ˆ æ¨¡æ¿å¿«ç…§ (ADR-0015 Â§17)              â”‚       â”‚
â”‚  â”‚      final_cpu_request = '4',              ğŸ‘ˆ æœ€ç»ˆ CPU request (è¶…å–è°ƒæ•´å)        â”‚       â”‚
â”‚  â”‚      final_cpu_limit = '8',                                                       â”‚       â”‚
â”‚  â”‚      final_mem_request = '16Gi',           ğŸ‘ˆ æœ€ç»ˆå†…å­˜ request                     â”‚       â”‚
â”‚  â”‚      final_mem_limit = '32Gi',                                                    â”‚       â”‚
â”‚  â”‚      final_disk_gb = 100                   ğŸ‘ˆ æœ€ç»ˆç£ç›˜å¤§å°                          â”‚       â”‚
â”‚  â”‚  WHERE id = 'ticket-001';                                                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. æ›´æ–°é¢†åŸŸäº‹ä»¶çŠ¶æ€ (ADR-0009) ğŸ‘ˆ å¿…é¡»                                           â”‚       â”‚
â”‚  â”‚  UPDATE domain_events SET                                                         â”‚       â”‚
â”‚  â”‚      status = 'PROCESSING',               ğŸ‘ˆ çŠ¶æ€å˜æ›´: PENDING â†’ PROCESSING         â”‚       â”‚
â”‚  â”‚      updated_at = NOW()                                                           â”‚       â”‚
â”‚  â”‚  WHERE id = 'evt-001';                                                            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. ç”Ÿæˆ VM åç§°å¹¶åˆ›å»º VM è®°å½•                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO vms (                                                                â”‚       â”‚
â”‚  â”‚      id, name, service_id, namespace, cluster_id,                                 â”‚       â”‚
â”‚  â”‚      instance_size_id, template_id, status,                                       â”‚       â”‚
â”‚  â”‚      ticket_id, created_at                                                        â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'vm-001',                                                                    â”‚       â”‚
â”‚  â”‚      'prod-shop-shop-redis-01',            ğŸ‘ˆ è‡ªåŠ¨ç”Ÿæˆ: {ns}-{sys}-{svc}-{index}   â”‚       â”‚
â”‚  â”‚      'svc-001', 'prod-shop', 'cluster-a',                                         â”‚       â”‚
â”‚  â”‚      'is-gpu-workstation', 'tpl-centos7',                                         â”‚       â”‚
â”‚  â”‚      'CREATING',                           ğŸ‘ˆ åˆå§‹çŠ¶æ€: åˆ›å»ºä¸­                      â”‚       â”‚
â”‚  â”‚      'ticket-001', NOW()                                                          â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 4. æ’å…¥ River Job (ADR-0006/0012) ğŸ‘ˆ å¿…é¡» - è§¦å‘å¼‚æ­¥æ‰§è¡Œ                         â”‚       â”‚
â”‚  â”‚  INSERT INTO river_job (                                                          â”‚       â”‚
â”‚  â”‚      id, kind, args, queue, state, created_at                                     â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'job-001',                                                                   â”‚       â”‚
â”‚  â”‚      'VMCreateJob',                        ğŸ‘ˆ River worker ç±»å‹                     â”‚       â”‚
â”‚  â”‚      '{"event_id": "evt-001", "vm_id": "vm-001", "ticket_id": "ticket-001"}',    â”‚       â”‚
â”‚  â”‚      'default',                                                                   â”‚       â”‚
â”‚  â”‚      'available',                          ğŸ‘ˆ å¯è¢« worker æ¶ˆè´¹                      â”‚       â”‚
â”‚  â”‚      NOW()                                                                        â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚  -- æ³¨æ„: ä»£ç ä¸­ä½¿ç”¨ riverClient.InsertTx(), è€ŒéåŸå§‹ INSERT                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 5. è®°å½•å®¡è®¡æ—¥å¿—                                                                 â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (                                                         â”‚       â”‚
â”‚  â”‚      id, action, actor_id, resource_type, resource_id, details, created_at        â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'log-002', 'REQUEST_APPROVED', 'admin.li',                                   â”‚       â”‚
â”‚  â”‚      'approval_ticket', 'ticket-001',                                             â”‚       â”‚
â”‚  â”‚      '{"cluster": "cluster-a", "vm_name": "prod-shop-shop-redis-01"}',            â”‚       â”‚
â”‚  â”‚      NOW()                                                                        â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 6. å‘é€é€šçŸ¥ç»™ç”¨æˆ·                                                               â”‚       â”‚
â”‚  â”‚  INSERT INTO notifications (                                                      â”‚       â”‚
â”‚  â”‚      id, recipient_id, type, title, content, related_ticket_id, created_at        â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'notif-002', 'zhang.san', 'REQUEST_APPROVED',                                â”‚       â”‚
â”‚  â”‚      'æ‚¨çš„ VM è¯·æ±‚å·²æ‰¹å‡†', 'VM prod-shop-shop-redis-01 æ­£åœ¨åˆ›å»º...',               â”‚       â”‚
â”‚  â”‚      'ticket-001', NOW()                                                          â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“Š çŠ¶æ€æµè½¬:                                                                                â”‚
â”‚     - ApprovalTicket: PENDING_APPROVAL â†’ APPROVED                                            â”‚
â”‚     - DomainEvent: PENDING â†’ PROCESSING                                                      â”‚
â”‚     - VM: (æ— ) â†’ CREATING                                                                    â”‚
â”‚     - RiverJob: (æ— ) â†’ available                                                             â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ”„ å¼‚æ­¥æ‰§è¡Œ: River worker è¯»å– Jobï¼Œè°ƒç”¨ KubeVirt API                                         â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç®¡ç†å‘˜æ‹’ç» VM è¯·æ±‚ - æ•°æ®åº“æ“ä½œ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç®¡ç†å‘˜ç‚¹å‡» [æ‹’ç»] æŒ‰é’®:                                                                       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡ - ADR-0012):                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. æ›´æ–°å·¥å•çŠ¶æ€                                                                 â”‚       â”‚
â”‚  â”‚  UPDATE approval_tickets SET                                                      â”‚       â”‚
â”‚  â”‚      status = 'REJECTED',                  ğŸ‘ˆ çŠ¶æ€å˜æ›´: PENDING â†’ REJECTED         â”‚       â”‚
â”‚  â”‚      approver_id = 'admin.li',                                                    â”‚       â”‚
â”‚  â”‚      rejected_at = NOW(),                                                         â”‚       â”‚
â”‚  â”‚      rejection_reason = 'èµ„æºä¸è¶³ï¼Œè¯·é€‰æ‹©å…¶ä»–InstanceSizeï¼ˆè§„æ ¼ï¼‰'                  â”‚       â”‚
â”‚  â”‚  WHERE id = 'ticket-001';                                                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. æ›´æ–°é¢†åŸŸäº‹ä»¶çŠ¶æ€ (ADR-0009) ğŸ‘ˆ å¿…é¡»                                           â”‚       â”‚
â”‚  â”‚  UPDATE domain_events SET                                                         â”‚       â”‚
â”‚  â”‚      status = 'CANCELLED',                ğŸ‘ˆ çŠ¶æ€å˜æ›´: PENDING â†’ CANCELLED (è¢«æ‹’ç») â”‚       â”‚
â”‚  â”‚      updated_at = NOW()                                                           â”‚       â”‚
â”‚  â”‚  WHERE id = 'evt-001';                                                            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. è®°å½•å®¡è®¡æ—¥å¿—                                                                 â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (...) VALUES (...);                                       â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 4. é€šçŸ¥ç”¨æˆ·                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO notifications (...) VALUES (...);                                    â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“Š çŠ¶æ€æµè½¬:                                                                                â”‚
â”‚     - ApprovalTicket: PENDING_APPROVAL â†’ REJECTED                                            â”‚
â”‚     - DomainEvent: PENDING â†’ CANCELLED                                                       â”‚
â”‚  âŒ æ—  VM è®°å½•åˆ›å»º, æ—  River Job æ’å…¥                                                         â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é˜¶æ®µ 5.D: åˆ é™¤æ“ä½œ

> **è¯´æ˜**: VM/Service/System çš„åˆ é™¤æµç¨‹å’Œæ•°æ®åº“æ“ä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åˆ é™¤æµç¨‹ - å±‚çº§ä¾èµ–å…³ç³»                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å±‚çº§ç»“æ„ (å‚è€ƒ ADR-0015):                                                                    â”‚
â”‚                                                                                              â”‚
â”‚      System (shop)                                                                           â”‚
â”‚         â”‚                                                                                    â”‚
â”‚         â”œâ”€â”€ Service (redis)                                                                  â”‚
â”‚         â”‚      â”œâ”€â”€ VM (prod-shop-shop-redis-01)                                             â”‚
â”‚         â”‚      â””â”€â”€ VM (prod-shop-shop-redis-02)                                             â”‚
â”‚         â”‚                                                                                    â”‚
â”‚         â””â”€â”€ Service (mysql)                                                                  â”‚
â”‚                â””â”€â”€ VM (prod-shop-shop-mysql-01)                                             â”‚
â”‚                                                                                              â”‚
â”‚  åˆ é™¤è§„åˆ™ (Cascade Restrict):                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  åˆ é™¤å±‚çº§      å‰ç½®æ¡ä»¶                    éœ€è¦å®¡æ‰¹    ç¡®è®¤æ–¹å¼                     â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚       â”‚
â”‚  â”‚  VM            æ—                           âœ… æ˜¯       confirm=true å‚æ•°          â”‚       â”‚
â”‚  â”‚  Service       ä¸‹å±æ‰€æœ‰ VM å¿…é¡»å…ˆåˆ é™¤      âœ… æ˜¯       confirm=true å‚æ•°          â”‚       â”‚
â”‚  â”‚  System        ä¸‹å±æ‰€æœ‰ Service å¿…é¡»å…ˆåˆ é™¤ âŒ å¦       è¾“å…¥ç³»ç»Ÿåç§°ç¡®è®¤            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åˆ é™¤ VM - æ•°æ®åº“æ“ä½œ                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·æˆ–ç®¡ç†å‘˜å‘èµ·åˆ é™¤:                                                                         â”‚
â”‚  DELETE /api/v1/vms/{vm_id}?confirm=true                                                    â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºåˆ é™¤å®¡æ‰¹å·¥å•                                                             â”‚       â”‚
â”‚  â”‚  INSERT INTO approval_tickets (                                                   â”‚       â”‚
â”‚  â”‚      id, type, status, requester_id, resource_type, resource_id, created_at       â”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'ticket-002', 'VM_DELETE', 'PENDING_APPROVAL',                               â”‚       â”‚
â”‚  â”‚      'zhang.san', 'vm', 'vm-001', NOW()                                           â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. è®°å½•å®¡è®¡æ—¥å¿—                                                                 â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (                                                         â”‚       â”‚
â”‚  â”‚      action, actor_id, resource_type, resource_id, parent_type, parent_id, detailsâ”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'vm.delete_request', 'zhang.san', 'vm', 'vm-001', 'service', 'svc-001',      â”‚       â”‚
â”‚  â”‚      '{"name": "prod-shop-shop-redis-01", "reason": "èµ„æºå›æ”¶"}'                   â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ç®¡ç†å‘˜æ‰¹å‡†å:                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. æ›´æ–°å·¥å•çŠ¶æ€                                                                 â”‚       â”‚
â”‚  â”‚  UPDATE approval_tickets SET status = 'APPROVED', ... WHERE id = 'ticket-002';    â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. æ›´æ–° VM çŠ¶æ€ä¸º DELETING (ä¸æ˜¯ç›´æ¥åˆ é™¤è®°å½•)                                    â”‚       â”‚
â”‚  â”‚  UPDATE vms SET status = 'DELETING' WHERE id = 'vm-001';                          â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. è®°å½•å®¡è®¡æ—¥å¿—                                                                 â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (                                                         â”‚       â”‚
â”‚  â”‚      action, actor_id, resource_type, resource_id, parent_type, parent_id, detailsâ”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'vm.delete', 'admin.li', 'vm', 'vm-001', 'service', 'svc-001',               â”‚       â”‚
â”‚  â”‚      '{"name": "prod-shop-shop-redis-01", "approved_by": "admin.li"}'             â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ”„ å¼‚æ­¥ä»»åŠ¡: Worker æ‰§è¡Œ kubectl delete vmï¼ŒæˆåŠŸåæ›´æ–° status = 'DELETED'                    â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åˆ é™¤ Service - æ•°æ®åº“æ“ä½œ                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  DELETE /api/v1/services/{service_id}?confirm=true                                          â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- å‰ç½®æ£€æŸ¥: æ˜¯å¦æœ‰æ´»è·ƒ VM                                                         â”‚       â”‚
â”‚  â”‚  SELECT COUNT(*) FROM vms                                                         â”‚       â”‚
â”‚  â”‚  WHERE service_id = 'svc-001' AND status NOT IN ('DELETED', 'DELETING');          â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  IF count > 0 THEN                                                                â”‚       â”‚
â”‚  â”‚      RETURN ERROR("æœåŠ¡ä¸‹è¿˜æœ‰ {count} ä¸ªæ´»è·ƒ VMï¼Œè¯·å…ˆåˆ é™¤");                        â”‚       â”‚
â”‚  â”‚  END IF;                                                                           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- åˆ›å»ºåˆ é™¤å®¡æ‰¹å·¥å• (åŒ VM åˆ é™¤æµç¨‹)                                                â”‚       â”‚
â”‚  â”‚  INSERT INTO approval_tickets (...);                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- è®°å½•å®¡è®¡æ—¥å¿—                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (                                                         â”‚       â”‚
â”‚  â”‚      action, actor_id, resource_type, resource_id, parent_type, parent_id, detailsâ”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'service.delete_request', 'zhang.san', 'service', 'svc-001', 'system', 'sys-001',â”‚     â”‚
â”‚  â”‚      '{"name": "redis", "reason": "æœåŠ¡è¿ç§»"}'                                     â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ç®¡ç†å‘˜æ‰¹å‡†å:                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  UPDATE services SET status = 'DELETED', deleted_at = NOW()                       â”‚       â”‚
â”‚  â”‚  WHERE id = 'svc-001';                                                            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- è®°å½•å®¡è®¡æ—¥å¿—                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (                                                         â”‚       â”‚
â”‚  â”‚      action, actor_id, resource_type, resource_id, parent_type, parent_id, detailsâ”‚       â”‚
â”‚  â”‚  ) VALUES (                                                                        â”‚       â”‚
â”‚  â”‚      'service.delete', 'admin.li', 'service', 'svc-001', 'system', 'sys-001',     â”‚       â”‚
â”‚  â”‚      '{"name": "redis", "approved_by": "admin.li"}'                               â”‚       â”‚
â”‚  â”‚  );                                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- è½¯åˆ é™¤: è®°å½•ä¿ç•™ç”¨äºå®¡è®¡                                                         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åˆ é™¤ System - æ•°æ®åº“æ“ä½œ (æ— éœ€å®¡æ‰¹)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  DELETE /api/v1/systems/{system_id}                                                         â”‚
â”‚  Body: { "confirm_name": "shop" }    ğŸ‘ˆ å¿…é¡»è¾“å…¥ç³»ç»Ÿåç§°ç¡®è®¤                                  â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- å‰ç½®æ£€æŸ¥ 1: ç¡®è®¤åç§°åŒ¹é…                                                        â”‚       â”‚
â”‚  â”‚  IF confirm_name != system.name THEN                                              â”‚       â”‚
â”‚  â”‚      RETURN ERROR("ç¡®è®¤åç§°ä¸åŒ¹é…");                                               â”‚       â”‚
â”‚  â”‚  END IF;                                                                           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å‰ç½®æ£€æŸ¥ 2: æ˜¯å¦æœ‰æ´»è·ƒ Service                                                  â”‚       â”‚
â”‚  â”‚  SELECT COUNT(*) FROM services                                                    â”‚       â”‚
â”‚  â”‚  WHERE system_id = 'sys-001' AND status != 'DELETED';                             â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  IF count > 0 THEN                                                                â”‚       â”‚
â”‚  â”‚      RETURN ERROR("ç³»ç»Ÿä¸‹è¿˜æœ‰ {count} ä¸ªæœåŠ¡ï¼Œè¯·å…ˆåˆ é™¤");                           â”‚       â”‚
â”‚  â”‚  END IF;                                                                           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- æ‰§è¡Œè½¯åˆ é™¤ (æ— éœ€å®¡æ‰¹)                                                           â”‚       â”‚
â”‚  â”‚  UPDATE systems SET status = 'DELETED', deleted_at = NOW()                        â”‚       â”‚
â”‚  â”‚  WHERE id = 'sys-001';                                                            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- è®°å½•å®¡è®¡æ—¥å¿—                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (...) VALUES (...);                                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âŒ ä¸åˆ›å»ºå®¡æ‰¹å·¥å•: System åˆ é™¤ç”±åç§°ç¡®è®¤ä¿æŠ¤ï¼Œæ— éœ€å®¡æ‰¹                                         â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 4: çŠ¶æ€æœºä¸æ•°æ®æ¨¡å‹

> **è¯´æ˜**: æœ¬èŠ‚å®šä¹‰ç³»ç»Ÿä¸­æ ¸å¿ƒå®ä½“çš„çŠ¶æ€æœºå’Œæ•°æ®åº“è¡¨å…³ç³»ï¼Œæ˜¯å‰åç«¯å¼€å‘çš„é‡è¦å‚è€ƒã€‚

### å®¡æ‰¹å·¥å•çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¡æ‰¹å·¥å• (ApprovalTicket) çŠ¶æ€æµè½¬                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚                        â”‚  PENDING_APPROVAL â”‚                                                 â”‚
â”‚                        â”‚     (å¾…å®¡æ‰¹)       â”‚                                                 â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                  â”‚                                                           â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚              â”‚                   â”‚                   â”‚                                      â”‚
â”‚              â–¼                   â–¼                   â–¼                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚     â”‚  APPROVED   â”‚     â”‚  REJECTED   â”‚     â”‚  CANCELLED  â”‚                                 â”‚
â”‚     â”‚   (å·²æ‰¹å‡†)   â”‚     â”‚   (å·²æ‹’ç»)   â”‚     â”‚  (å·²å–æ¶ˆ)   â”‚                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚            â”‚                 (ç»ˆæ€)              (ç»ˆæ€)                                      â”‚
â”‚            â–¼                                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                          â”‚
â”‚     â”‚  EXECUTING  â”‚                                                                          â”‚
â”‚     â”‚   (æ‰§è¡Œä¸­)   â”‚                                                                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                                          â”‚
â”‚            â”‚                                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                                                          â”‚
â”‚     â–¼             â–¼                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                    â”‚
â”‚  â”‚ SUCCESS â”‚  â”‚ FAILED  â”‚                                                                    â”‚
â”‚  â”‚ (æˆåŠŸ)   â”‚  â”‚ (å¤±è´¥)   â”‚                                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                    â”‚
â”‚    (ç»ˆæ€)       (ç»ˆæ€)                                                                        â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VM çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VM çŠ¶æ€æµè½¬                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚     â”‚  CREATING   â”‚â”€â”€â”€â”€â–¶â”‚   RUNNING   â”‚â—€â”€â”€â”€â”€â”‚   STOPPED   â”‚                                 â”‚
â”‚     â”‚   (åˆ›å»ºä¸­)   â”‚     â”‚   (è¿è¡Œä¸­)   â”‚     â”‚   (å·²åœæ­¢)   â”‚                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚            â”‚                   â”‚                   â–²                                         â”‚
â”‚            â”‚                   â–¼                   â”‚                                         â”‚
â”‚            â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                                         â”‚
â”‚            â”‚            â”‚  STOPPING   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚            â”‚            â”‚   (åœæ­¢ä¸­)   â”‚                                                      â”‚
â”‚            â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚            â”‚                                                                                 â”‚
â”‚            â”‚                   â”‚                                                             â”‚
â”‚            â–¼                   â–¼                                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚     â”‚   FAILED    â”‚     â”‚  DELETING   â”‚                                                      â”‚
â”‚     â”‚  (åˆ›å»ºå¤±è´¥)  â”‚     â”‚   (åˆ é™¤ä¸­)   â”‚                                                      â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                â”‚                                                             â”‚
â”‚                                â–¼                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚                         â”‚   DELETED   â”‚                                                      â”‚
â”‚                         â”‚   (å·²åˆ é™¤)   â”‚                                                      â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                              (ç»ˆæ€)                                                           â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ•°æ®åº“è¡¨å…³ç³»æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ ¸å¿ƒè¡¨å…³ç³»å›¾                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚   systems    â”‚ 1 â”€â”€â”€ N â”‚   services   â”‚ 1 â”€â”€â”€ N â”‚     vms      â”‚                         â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
â”‚  â”‚ id           â”‚         â”‚ id           â”‚         â”‚ id           â”‚                         â”‚
â”‚  â”‚ name         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ system_id    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ service_id   â”‚                         â”‚
â”‚  â”‚ description  â”‚         â”‚ name         â”‚         â”‚ name         â”‚                         â”‚
â”‚  â”‚ status       â”‚         â”‚ status       â”‚         â”‚ status       â”‚                         â”‚
â”‚  â”‚ created_by   â”‚         â”‚ created_by   â”‚         â”‚ namespace    â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ cluster_id   â”‚                         â”‚
â”‚         â”‚                                          â”‚ ticket_id    â”‚                         â”‚
â”‚         â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚                                                  â”‚                                 â”‚
â”‚         â–¼                                                  â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ role_bindingsâ”‚                               â”‚ approval_tickets â”‚                        â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
â”‚  â”‚ user_id      â”‚                               â”‚ id               â”‚                        â”‚
â”‚  â”‚ role         â”‚                               â”‚ type             â”‚                        â”‚
â”‚  â”‚ resource_typeâ”‚                               â”‚ status           â”‚                        â”‚
â”‚  â”‚ resource_id  â”‚                               â”‚ requester_id     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚ approver_id      â”‚                        â”‚
â”‚                                                 â”‚ service_id       â”‚                        â”‚
â”‚                                                 â”‚ instance_size_id â”‚                        â”‚
â”‚                                                 â”‚ template_id      â”‚                        â”‚
â”‚                                                 â”‚ final_*          â”‚ â† å®¡æ‰¹æ—¶ç¡®å®šçš„æœ€ç»ˆå€¼    â”‚
â”‚                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                          â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                                  â”‚
â”‚  â”‚instance_sizesâ”‚         â”‚  templates   â”‚              â–¼                                  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ id           â”‚         â”‚ id           â”‚       â”‚ audit_logs   â”‚                          â”‚
â”‚  â”‚ name         â”‚         â”‚ name         â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
â”‚  â”‚ spec_overridesâ”‚        â”‚ image_source â”‚       â”‚ action       â”‚                          â”‚
â”‚  â”‚ cpu_overcommitâ”‚        â”‚ cloud_init   â”‚       â”‚ actor_id     â”‚                          â”‚
â”‚  â”‚ mem_overcommitâ”‚        â”‚ version      â”‚       â”‚ resource_*   â”‚                          â”‚
â”‚  â”‚ disk_gb_*    â”‚         â”‚ status       â”‚       â”‚ details      â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ created_at   â”‚                          â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®¡è®¡æ—¥å¿—è®¾è®¡

> **å‚è€ƒ**: ADR-0015 Â§7 (Deletion & Cascade Constraints) - "audit records are preserved"

> ğŸ“¦ **Schema**: å®Œæ•´ DDL å’Œç´¢å¼•å®šä¹‰è§ [04-governance.md Â§7 Storage Schema](../../../design/phases/04-governance.md#storage-schema)

#### éœ€è¦è®°å½•å®¡è®¡çš„æ“ä½œ

| ç±»åˆ« | æ“ä½œ (action) | è§¦å‘æ—¶æœº | è¯¦æƒ… (details) å†…å®¹ |
|------|---------------|----------|---------------------|
| **è®¤è¯** | `user.login` | ç”¨æˆ·ç™»å½•æˆåŠŸ | `{method: "oidc", idp: "Corp-SSO"}` |
| **è®¤è¯** | `user.login_failed` | ç™»å½•å¤±è´¥ | `{reason: "invalid_token"}` |
| **è®¤è¯** | `user.logout` | ç”¨æˆ·ç™»å‡º | `{}` |
| **System** | `system.create` | åˆ›å»ºç³»ç»Ÿ | `{name: "shop", description: "..."}` |
| **System** | `system.update` | ä¿®æ”¹ç³»ç»Ÿ | `{changes: {description: {old: "...", new: "..."}}}` |
| **System** | `system.delete` | åˆ é™¤ç³»ç»Ÿ | `{confirmation: "shop"}` |
| **Service** | `service.create` | åˆ›å»ºæœåŠ¡ | `{name: "redis", system_id: "..."}` |
| **Service** | `service.delete_request` | æäº¤æœåŠ¡åˆ é™¤è¯·æ±‚ | `{name: "redis", reason: "æœåŠ¡è¿ç§»"}` |
| **Service** | `service.delete` | åˆ é™¤æœåŠ¡ (å®¡æ‰¹å) | `{approved_by: "..."}` |
| **VM** | `vm.request` | æäº¤ VM åˆ›å»ºè¯·æ±‚ | `{instance_size: "...", template: "...", count: 3}` |
| **VM** | `vm.create` | VM åˆ›å»ºæˆåŠŸ | `{cluster: "...", namespace: "..."}` |
| **VM** | `vm.start` | å¯åŠ¨ VM | `{}` |
| **VM** | `vm.stop` | åœæ­¢ VM | `{graceful: true}` |
| **VM** | `vm.restart` | é‡å¯ VM | `{}` |
| **VM** | `vm.delete_request` | æäº¤ VM åˆ é™¤è¯·æ±‚ | `{name: "...", reason: "èµ„æºå›æ”¶"}` |
| **VM** | `vm.delete` | åˆ é™¤ VM (å®¡æ‰¹å) | `{approved_by: "..."}`  |
| **VNC** | `vnc.access` | è®¿é—® VNC æ§åˆ¶å° | `{vm_id: "...", session_duration: 3600}` |
| **Approval** | `approval.approve` | æ‰¹å‡†è¯·æ±‚ | `{ticket_id: "...", final_cluster: "...", final_disk_gb: 100}` |
| **Approval** | `approval.reject` | æ‹’ç»è¯·æ±‚ | `{ticket_id: "...", reason: "èµ„æºä¸è¶³"}` |
| **Approval** | `approval.cancel` | å–æ¶ˆè¯·æ±‚ | `{ticket_id: "...", reason: "ä¸å†éœ€è¦"}` |
| **RBAC** | `role.create` | åˆ›å»ºè‡ªå®šä¹‰è§’è‰² | `{name: "CustomViewer", permissions: [...]}` |
| **RBAC** | `role.update` | ä¿®æ”¹è§’è‰²æƒé™ | `{role: "Operator", changes: {permissions: {added: [...], removed: [...]}}}` |
| **RBAC** | `role.delete` | åˆ é™¤è‡ªå®šä¹‰è§’è‰² | `{name: "CustomViewer"}` |
| **RBAC** | `role.assign` | åˆ†é…è§’è‰²ç»™ç”¨æˆ· | `{user_id: "...", role: "SystemAdmin", scope: "system:shop"}` |
| **RBAC** | `role.revoke` | æ’¤é”€ç”¨æˆ·è§’è‰² | `{user_id: "...", role: "Operator"}` |
| **RBAC** | `permission.create` | åˆ›å»ºæƒé™ | `{code: "vm:vnc", description: "..."}` |
| **RBAC** | `permission.delete` | åˆ é™¤æƒé™ | `{code: "vm:vnc"}` |
| **Cluster** | `cluster.register` | æ³¨å†Œé›†ç¾¤ | `{name: "prod-01", environment: "prod", api_server: "..."}` |
| **Cluster** | `cluster.update` | ä¿®æ”¹é›†ç¾¤é…ç½® | `{name: "prod-01", changes: {environment: {old: "test", new: "prod"}}}` |
| **Cluster** | `cluster.delete` | åˆ é™¤/æ³¨é”€é›†ç¾¤ | `{name: "prod-01", reason: "é›†ç¾¤ä¸‹çº¿"}` |
| **Cluster** | `cluster.credential_rotate` | è½®æ¢é›†ç¾¤å‡­è¯ | `{name: "prod-01", rotated_at: "..."}` |
| **Template** | `template.create` | åˆ›å»ºæ¨¡æ¿ | `{name: "centos7-docker", version: 1}` |
| **Template** | `template.update` | æ›´æ–°æ¨¡æ¿ (ç‰ˆæœ¬+1) | `{name: "centos7-docker", version: 2, changes: {...}}` |
| **Template** | `template.deprecate` | æ ‡è®°æ¨¡æ¿ä¸ºå¼ƒç”¨ | `{name: "centos6-base", successor: "centos7-base"}` |
| **Template** | `template.delete` | åˆ é™¤æ¨¡æ¿ | `{name: "centos6-base", version: 3}` |
| **InstanceSize** | `instance_size.create` | åˆ›å»ºInstanceSizeï¼ˆè§„æ ¼ï¼‰ | `{name: "medium-gpu", cpu: 4, memory: "8Gi", gpu: 1}` |
| **InstanceSize** | `instance_size.update` | ä¿®æ”¹InstanceSizeï¼ˆè§„æ ¼ï¼‰ | `{name: "medium-gpu", changes: {memory: {old: "8Gi", new: "16Gi"}}}` |
| **InstanceSize** | `instance_size.deprecate` | æ ‡è®°InstanceSizeï¼ˆè§„æ ¼ï¼‰ä¸ºå¼ƒç”¨ | `{name: "small-legacy"}` |
| **InstanceSize** | `instance_size.delete` | åˆ é™¤InstanceSizeï¼ˆè§„æ ¼ï¼‰ | `{name: "small-legacy"}` |
| **Namespace** | `namespace.create` | åˆ›å»ºå‘½åç©ºé—´ | `{name: "prod-shop", cluster: "prod-01"}` |
| **Namespace** | `namespace.delete` | åˆ é™¤å‘½åç©ºé—´ | `{name: "prod-shop"}` |
| **IdP** | `idp.configure` | é…ç½® IdP è¿æ¥ | `{type: "oidc", issuer: "...", client_id: "..."}` |
| **IdP** | `idp.update` | æ›´æ–° IdP é…ç½® | `{changes: {issuer: {...}}}` |
| **IdP** | `idp.delete` | åˆ é™¤ IdP é…ç½® | `{type: "oidc"}` |
| **IdP** | `idp.sync` | æ‰‹åŠ¨åŒæ­¥ IdP ç»„ | `{synced_groups: 15, new_users: 3}` |
| **IdP** | `idp.mapping_create` | åˆ›å»ºç»„-è§’è‰²æ˜ å°„ | `{idp_group: "DevOps", role: "SystemAdmin", env: "prod"}` |
| **IdP** | `idp.mapping_update` | æ›´æ–°ç»„-è§’è‰²æ˜ å°„ | `{idp_group: "DevOps", changes: {role: {old: "Viewer", new: "Operator"}}}` |
| **IdP** | `idp.mapping_delete` | åˆ é™¤ç»„-è§’è‰²æ˜ å°„ | `{idp_group: "DevOps"}` |
| **Config** | `config.update` | ä¿®æ”¹å¹³å°é…ç½® | `{key: "approval.timeout_hours", old: 24, new: 48}` |

#### ä¸éœ€è¦è®°å½•å®¡è®¡çš„æ“ä½œ (ä¾‹å¤–)

ä»¥ä¸‹æ“ä½œå› å…¶é«˜é¢‘æˆ–ä½æ•æ„Ÿæ€§ï¼Œ**ä¸è®°å½•å®¡è®¡æ—¥å¿—**ï¼š

| ç±»åˆ« | æ“ä½œ | ä¸è®°å½•åŸå›  |
|------|------|-----------|
| **ç³»ç»Ÿå·¡æ£€** | K8s é›†ç¾¤å®šæ—¶å¥åº·æ£€æŸ¥ | é«˜é¢‘å®šæ—¶ä»»åŠ¡ï¼Œæ— ç”¨æˆ·è§¦å‘ |
| **ç³»ç»Ÿå·¡æ£€** | VM çŠ¶æ€åŒæ­¥è½®è¯¢ | æ¯åˆ†é’Ÿæ‰§è¡Œï¼Œæ•°æ®é‡è¿‡å¤§ |
| **ç³»ç»Ÿå·¡æ£€** | èµ„æºé…é¢æ£€æŸ¥ | å†…éƒ¨æ£€æŸ¥ï¼Œæ— ä¸šåŠ¡æ„ä¹‰ |
| **åªè¯»æ“ä½œ** | åˆ—è¡¨æŸ¥è¯¢ (`GET /api/v1/*`) | åªè¯»ä¸æ”¹å˜çŠ¶æ€ |
| **åªè¯»æ“ä½œ** | è¯¦æƒ…æŸ¥çœ‹ (`GET /api/v1/*/id`) | åªè¯»ä¸æ”¹å˜çŠ¶æ€ |
| **å†…éƒ¨é€šä¿¡** | Worker å¿ƒè·³ | ç³»ç»Ÿå†…éƒ¨é€šä¿¡ |
| **å†…éƒ¨é€šä¿¡** | Metrics é‡‡é›† | ç›‘æ§æ•°æ®é‡‡é›† |

> **ä¾‹å¤–å¤„ç†åŸåˆ™**:
> - æ‰€æœ‰ **å†™æ“ä½œ** (CREATE/UPDATE/DELETE) å¿…é¡»è®°å½•
> - æ‰€æœ‰ **æ•æ„Ÿè¯»æ“ä½œ** (å¦‚ VNC è®¿é—®) å¿…é¡»è®°å½•
> - çº¯ **ç³»ç»Ÿè‡ªåŠ¨åŒ–** å’Œ **åªè¯»æŸ¥è¯¢** å¯ä»¥è±å…

#### å®¡è®¡æ—¥å¿—è®°å½•ç¤ºä¾‹

```
ç¤ºä¾‹ 1: ç”¨æˆ·åˆ›å»º VM è¯·æ±‚
  INSERT INTO audit_logs (action, actor_id, actor_name, resource_type,
                          resource_id, parent_type, parent_id, details) VALUES
    ('vm.request', 'user-001', 'å¼ ä¸‰', 'approval_ticket', 'ticket-001',
     'service', 'svc-001',
     '{"instance_size": "medium-gpu", "template": "centos7-docker",
       "count": 3, "namespace": "prod-shop"}');

ç¤ºä¾‹ 2: ç®¡ç†å‘˜æ‰¹å‡†è¯·æ±‚
  INSERT INTO audit_logs (action, actor_id, actor_name, resource_type,
                          resource_id, details) VALUES
    ('approval.approve', 'admin-001', 'ç®¡ç†å‘˜æå››', 'approval_ticket', 'ticket-001',
     '{"final_cluster": "prod-cluster-01", "final_disk_gb": 100,
       "final_storage_class": "ceph-ssd", "vms_created": 3}');

ç¤ºä¾‹ 3: VNC è®¿é—®è®°å½•
  INSERT INTO audit_logs (action, actor_id, actor_name, resource_type,
                          resource_id, details, ip_address) VALUES
    ('vnc.access', 'user-001', 'å¼ ä¸‰', 'vm', 'vm-redis-01',
     '{"session_id": "vnc-xxx", "duration_seconds": 1800}',
     '192.168.1.100');

ç¤ºä¾‹ 4: åˆ é™¤èµ„æº (ä¿ç•™å®¡è®¡)
  -- åˆ é™¤ VM æ—¶ï¼Œå…ˆè®°å½•å®¡è®¡æ—¥å¿—
  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id,
                          parent_type, parent_id, details) VALUES
    ('vm.delete', 'user-001', 'vm', 'vm-redis-01', 'service', 'svc-001',
     '{"name": "prod-shop-redis-01", "cluster": "prod-cluster-01",
       "existed_days": 45, "last_status": "RUNNING"}');
  
  -- ç„¶åæ‰§è¡Œç¡¬åˆ é™¤
  DELETE FROM vms WHERE id = 'vm-redis-01';
  
  ğŸ’¡ å®¡è®¡æ—¥å¿—ä¿ç•™ï¼Œèµ„æºè®°å½•åˆ é™¤
```

#### å®¡è®¡æ—¥å¿—æŸ¥è¯¢ç¤ºä¾‹

```sql
-- Query all actions for a user
SELECT * FROM audit_logs 
WHERE actor_id = 'user-001' 
ORDER BY created_at DESC LIMIT 50;

-- Query resource history
SELECT * FROM audit_logs 
WHERE resource_type = 'vm' AND resource_id = 'vm-redis-01'
ORDER BY created_at DESC;

-- Query all approval actions
SELECT * FROM audit_logs 
WHERE action LIKE 'approval.%' 
ORDER BY created_at DESC;

-- Query sensitive prod actions
SELECT * FROM audit_logs 
WHERE environment = 'prod' 
  AND action IN ('vm.delete', 'system.delete', 'approval.approve')
ORDER BY created_at DESC;
```

#### å®¡è®¡æ—¥å¿—ä¿ç•™ç­–ç•¥

| ç¯å¢ƒ | ä¿ç•™æ—¶é—´ | è¯´æ˜ |
|------|----------|------|
| **ç”Ÿäº§ç¯å¢ƒ** | â‰¥ 1 å¹´ | æ»¡è¶³åˆè§„è¦æ±‚ |
| **æµ‹è¯•ç¯å¢ƒ** | â‰¥ 90 å¤© | å¯é…ç½®ç¼©çŸ­ |
| **æ•æ„Ÿæ“ä½œ** | â‰¥ 3 å¹´ | `*.delete`, `approval.*`, `rbac.*` |

---

### å®¡è®¡æ—¥å¿— JSON å¯¼å‡º (v1+)

> **åœºæ™¯**: å°†å®¡è®¡æ—¥å¿—é›†æˆåˆ°ä¼ä¸šçº§ SIEM ç³»ç»Ÿï¼ˆElasticsearchã€Datadogã€Splunk ç­‰ï¼‰

> ğŸ“¦ **API è§„èŒƒ**: å®Œæ•´ API å’Œå“åº”æ ¼å¼è§ [04-governance.md Â§7 JSON Export API](../../../design/phases/04-governance.md#7-json-export-api)

**ä¸»è¦åŠŸèƒ½**:
- æ”¯æŒæ—¶é—´èŒƒå›´è¿‡æ»¤çš„åˆ†é¡µå¯¼å‡º
- Webhook æ¨é€é›†æˆï¼Œå®ç°å®æ—¶æµå¼ä¼ è¾“
- ç»“æ„åŒ– JSON æ ¼å¼ï¼Œå…¼å®¹ä¸»æµæ—¥å¿—èšåˆå™¨

---

### å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿé›†æˆ (v1+)

> **åœºæ™¯**: ä¸ä¼ä¸šç°æœ‰ ITSM ç³»ç»Ÿï¼ˆJira Service Managementã€ServiceNow ç­‰ï¼‰é›†æˆ

#### è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿé›†æˆæ¶æ„                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Shepherd   â”‚  â”€â”€â”€â”€ Webhook â”€â”€â”€â–¶ â”‚  å¤–éƒ¨ç³»ç»Ÿ    â”‚  â”€â”€â”€â”€ Callback â”€â”€â–¶ â”‚   Shepherd   â”‚   â”‚
â”‚  â”‚   Platform   â”‚                    â”‚ (Jira/SNOW)  â”‚                    â”‚   Platform   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  å…³é”®åŸåˆ™:                                                                                    â”‚
â”‚  1. Shepherd åªå…³æ³¨æ ‡å‡† API æ¥å£ï¼Œä¸å…³å¿ƒå¤–éƒ¨ç³»ç»Ÿå†…éƒ¨æµè½¬                                         â”‚
â”‚  2. é‡‡ç”¨å¼‚æ­¥äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ                                                        â”‚
â”‚  3. å¤–éƒ¨å®¡æ‰¹æ˜¯å¯æ’æ‹”çš„ï¼Œv1 é»˜è®¤ä½¿ç”¨å†…ç½®å®¡æ‰¹                                                     â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¤–éƒ¨å®¡æ‰¹é…ç½® (é€šè¿‡ Web UI é…ç½®ï¼Œå­˜å‚¨äº PostgreSQL)

> ç®¡ç†å‘˜åœ¨ **è®¾ç½® â†’ å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ â†’ æ·»åŠ ** è¿›è¡Œé…ç½®ï¼Œæ‰€æœ‰é…ç½®å­˜å‚¨åœ¨ `external_approval_systems` è¡¨ä¸­ã€‚

```sql
-- Example: external_approval_systems record
INSERT INTO external_approval_systems (
  id, name, type, enabled,
  webhook_url, webhook_secret, webhook_headers,
  callback_secret, status_mapping,
  timeout_seconds, retry_count,
  created_by
) VALUES (
  'eas-001', 
  'Jira Service Management',
  'webhook',
  true,
  'https://jira.company.com/api/v2/tickets',
  'encrypted:AES256:xxx',  -- encrypted with ENCRYPTION_KEY
  '{"Authorization": "Bearer ${JIRA_TOKEN}"}',
  'encrypted:AES256:xxx',  -- HMAC secret for callback verification
  '{"Approved": "APPROVED", "Rejected": "REJECTED", "Cancelled": "CANCELLED"}',
  30, 3,
  'admin'
);
```

#### Webhook å‘é€æ ¼å¼ (Shepherd â†’ å¤–éƒ¨ç³»ç»Ÿ)

```json
// POST https://jira.company.com/api/v2/tickets
{
  "shepherd_ticket_id": "ticket-001",
  "type": "VM_CREATE",
  "callback_url": "https://shepherd.company.com/api/v1/approvals/callback",
  "requester": {
    "id": "zhang.san",
    "name": "å¼ ä¸‰",
    "email": "zhang.san@company.com"
  },
  "request_details": {
    "namespace": "prod-shop",
    "service": "redis",
    "instance_size": "medium-gpu",
    "template": "centos7-docker",
    "vm_count": 3,
    "reason": "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
  },
  "resource_summary": {
    "cpu_cores": 8,
    "memory_gb": 32,
    "disk_gb": 100,
    "gpu_count": 1
  },
  "environment": "prod",
  "created_at": "2026-01-26T10:14:16Z"
}
```

#### Callback æ¥æ”¶æ ¼å¼ (å¤–éƒ¨ç³»ç»Ÿ â†’ Shepherd)

```json
// POST https://shepherd.company.com/api/v1/approvals/callback
// Headers:
//   X-Shepherd-Signature: HMAC-SHA256 ç­¾å
//   Content-Type: application/json
{
  "shepherd_ticket_id": "ticket-001",
  "external_ticket_id": "JIRA-12345",    // å¤–éƒ¨ç³»ç»Ÿå·¥å• ID (ç”¨äºè¿½æº¯)
  "status": "Approved",                   // å¤–éƒ¨ç³»ç»ŸçŠ¶æ€ (å°†é€šè¿‡ status_mapping è½¬æ¢)
  "approver": {
    "id": "admin.li",
    "name": "ç®¡ç†å‘˜æå››"
  },
  "comments": "èµ„æºå……è¶³ï¼Œæ‰¹å‡†åˆ›å»º",
  "approved_at": "2026-01-26T11:30:00Z"
}
```

#### Shepherd å¤„ç†å›è°ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Callback å¤„ç†æµç¨‹                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  1. éªŒè¯ HMAC ç­¾å                                                                           â”‚
â”‚  2. æŸ¥æ‰¾ shepherd_ticket_id å¯¹åº”çš„å·¥å•                                                       â”‚
â”‚  3. é€šè¿‡ status_mapping è½¬æ¢çŠ¶æ€                                                             â”‚
â”‚  4. æ›´æ–°å·¥å•çŠ¶æ€å’Œ approver ä¿¡æ¯                                                              â”‚
â”‚  5. å¦‚æœ APPROVED:                                                                          â”‚
â”‚     a. è§¦å‘ VM åˆ›å»º Worker ä»»åŠ¡                                                              â”‚
â”‚     b. å‘é€é€šçŸ¥ç»™ç”³è¯·äºº                                                                      â”‚
â”‚  6. å¦‚æœ REJECTED:                                                                          â”‚
â”‚     a. è®°å½•æ‹’ç»åŸå›                                                                           â”‚
â”‚     b. å‘é€é€šçŸ¥ç»™ç”³è¯·äºº                                                                      â”‚
â”‚  7. è®°å½•å®¡è®¡æ—¥å¿—                                                                              â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é›†æˆæ³¨æ„äº‹é¡¹

| æ³¨æ„äº‹é¡¹ | è¯´æ˜ |
|----------|------|
| **å¹‚ç­‰æ€§** | Callback å¯èƒ½é‡è¯•ï¼Œéœ€ç¡®ä¿å¤šæ¬¡å¤„ç†åŒä¸€å›è°ƒä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ |
| **çŠ¶æ€åŒæ­¥** | å®šæœŸæ£€æŸ¥å¤–éƒ¨ç³»ç»Ÿä¸­ pending çŠ¶æ€çš„å·¥å•ï¼Œé˜²æ­¢å›è°ƒä¸¢å¤± |
| **è¶…æ—¶å¤„ç†** | é…ç½®å·¥å•è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶è‡ªåŠ¨å–æ¶ˆ |
| **å®‰å…¨æ€§** | å§‹ç»ˆéªŒè¯ HMAC ç­¾åï¼Œé˜²æ­¢ä¼ªé€ å›è°ƒ |
| **å›é€€æœºåˆ¶** | å¤–éƒ¨ç³»ç»Ÿä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°å†…ç½®å®¡æ‰¹ |

---
